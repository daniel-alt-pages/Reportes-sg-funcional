<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe Individual de Resultados</title>
    <link rel="shortcut icon" href="/assets/icons/icon_pestaña.svg" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='estilos.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='graficas_adicionales.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='graficas_individuales.css') }}">
    <script src="{{ url_for('static', filename='graficas.js') }}" defer></script>
    <script src="{{ url_for('static', filename='recursos.js') }}" defer></script>

</head>

<body>
    <div class="menu-superior">
        <div class="contenedor-menu">
            <div class="seccion-carga">
                <form id="formulario-archivos" class="contenedor-archivos-menu">
                    <div class="selector-simulacro-container" style="margin-right: 15px;">
                        <select id="selectorSimulacro" class="selector-simulacro"
                            style="padding: 8px 12px; border-radius: 8px; border: 2px solid #6366f1; background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); color: #fff; font-weight: bold; cursor: pointer; min-width: 180px;">
                            <option value="">Seleccionar Simulacro</option>
                        </select>
                        <span id="estadoSimulacro" style="margin-left: 8px; font-size: 12px; color: #94a3b8;"></span>
                    </div>
                    <button type="submit" class="boton-procesar" id="botonProcesar" disabled style="opacity: 0.5;">
                        <i class="fas fa-cogs"></i>
                        Procesar Simulacro
                    </button>
                </form>
            </div>
            <div class="controles-derecha">
                <select id="selectorEstudiante" class="selector-estudiante">
                    <option value="">Seleccione un estudiante</option>
                </select>
                <div class="selector-modo">
                    <select id="modoDescarga" class="selector-rango" onchange="cambiarModoDescarga()">
                        <option value="manual">Modo Manual</option>
                        <option value="automatico">Modo AutomÃ¡tico</option>
                    </select>
                </div>
                <div class="rango-descarga">
                    <div class="selectores-container">
                        <select id="inicioRango" class="selector-rango">
                            <option value="">Inicio</option>
                        </select>
                        <span class="separador">hasta</span>
                        <select id="finRango" class="selector-rango">
                            <option value="">Fin</option>
                        </select>
                    </div>
                    <button class="boton-descarga" onclick="iniciarDescargaAutomatica()">
                        <i class="fas fa-download"></i>
                        Descargar Rango
                    </button>
                </div>
                <button class="boton-descarga" onclick="descargarPDF()">
                    <i class="fas fa-download"></i>
                    Descargar PDF
                </button>
            </div>
        </div>
    </div>

    <div class="contenedor-principal" style="margin-top: 100px;">
        <div class="documento" id="documento">
            <!-- Contenedor de marca de agua -->
            <div class="marca-agua-container">
                <img src="/assets/watermarks/marca_de_agua.svg" alt="Marca de agua" class="marca-agua-imagen">
            </div>
            <header class="encabezado">
                <div class="header-content">
                    <div class="titulo-descripcion">
                        <h1>INFORME INDIVIDUAL DE RESULTADOS</h1>
                        <p class="descripcion">Este informe presenta los resultados obtenidos por el estudiante en la
                            prueba diagnÃ³stica basada en los estÃ¡ndares del ICFES. El objetivo de este diagnÃ³stico es
                            identificar fortalezas y aspectos por mejorar en las diferentes Ã¡reas evaluadas.</p>
                    </div>
                    <div class="logo-container">
                        <img src="/assets/icons/icon.svg" alt="Logo SeamosGenios" class="logo">
                    </div>
                </div>
            </header>

            <section class="datos-estudiante">
                <div class="info-container">
                    <h2>DATOS DEL ESTUDIANTE</h2>
                    <div class="campos-container">
                        <div class="campo">
                            <label>NOMBRE DE PILA:</label>
                            <input type="text" id="nombreEstudiante" value="USUARIO">
                        </div>
                        <div class="campo">
                            <label>TIPO DE PRUEBA:</label>
                            <select id="calEstudiante" class="cal-select">
                                <option value="PRESABER">PRESABER</option>
                                <option value="INDIV/REP">REPITENTE</option>
                                <option value="VALIDANTE">VALIDANTE</option>
                                <option value="ESTUDIANTE">SABER 11</option>
                            </select>
                        </div>
                        <div class="campo">
                            <label>TELÃ‰FONO:</label>
                            <input type="tel" id="telefonoEstudiante" placeholder="NÃºmero de telÃ©fono"
                                pattern="[0-9]*">
                        </div>
                        <div class="campo">
                            <label>DEPARTAMENTO:</label>
                            <select id="municipioEstudiante" class="municipio-select">
                                <option value="">Seleccione un departamento</option>
                                <option value="Amazonas">Amazonas</option>
                                <option value="Antioquia">Antioquia</option>
                                <option value="Arauca">Arauca</option>
                                <option value="Atlantico">AtlÃ¡ntico</option>
                                <option value="Bolivar">BolÃ­var</option>
                                <option value="Boyaca">BoyacÃ¡</option>
                                <option value="Caldas">Caldas</option>
                                <option value="Caqueta">CaquetÃ¡</option>
                                <option value="Casanare">Casanare</option>
                                <option value="Cauca">Cauca</option>
                                <option value="Cesar">Cesar</option>
                                <option value="Choco">ChocÃ³</option>
                                <option value="Cordoba">CÃ³rdoba</option>
                                <option value="Cundinamarca">Cundinamarca</option>
                                <option value="Guainia">GuainÃ­a</option>
                                <option value="Guaviare">Guaviare</option>
                                <option value="Huila">Huila</option>
                                <option value="La Guajira">La Guajira</option>
                                <option value="Magdalena">Magdalena</option>
                                <option value="Meta">Meta</option>
                                <option value="Narino">NariÃ±o</option>
                                <option value="Norte de Santander">Norte de Santander</option>
                                <option value="Putumayo">Putumayo</option>
                                <option value="Quindio">QuindÃ­o</option>
                                <option value="Risaralda">Risaralda</option>
                                <option value="San Andres y Providencia">San AndrÃ©s y Providencia</option>
                                <option value="Santander">Santander</option>
                                <option value="Sucre">Sucre</option>
                                <option value="Tolima">Tolima</option>
                                <option value="Valle del Cauca">Valle del Cauca</option>
                                <option value="Vaupes">VaupÃ©s</option>
                                <option value="Vichada">Vichada</option>
                                <option value="Bogota">BogotÃ¡, D.C.</option>
                                <option value="No aplica">No aplica</option>
                            </select>
                        </div>
                        <div class="campo">
                            <label>IDENTIFICACIÃ“N:</label>
                            <div class="documento-container">
                                <select class="tipo-documento" id="tipoDocumento">
                                    <option value="CC">CC</option>
                                    <option value="TI">TI</option>
                                    <option value="CE">CE</option>
                                    <option value="PA">PA</option>
                                    <option value="NIT">NIT</option>
                                </select>
                                <input type="number" id="identificacionEstudiante" class="numero-documento"
                                    placeholder="NÃºmero de documento" min="0" pattern="[0-9]*">
                            </div>
                        </div>
                        <div class="campo">
                            <label>FECHA:</label>
                            <input type="date" id="fechaAplicacion" value="2024-08-18">
                        </div>
                    </div>
                </div>
                <div>
                    <div class="puntaje-global">
                        <h3>PUNTAJE GLOBAL</h3>
                        <div class="puntaje" id="puntajeGlobal">500</div>
                        <div class="sg11-container">
                            <span class="sg11-prefix">SG11-</span>
                            <input type="text" class="sg11-input" id="sg11Numero" maxlength="4" placeholder="####">
                        </div>
                    </div>
                    <div class="redes-container">
                        <h3>@seamosgenios</h3>
                        <div class="qr-codes">
                            <div class="qr-code-item">
                                <img src="/assets/qr_codes/qr1.svg" alt="CÃ³digo QR 1">
                            </div>
                            <div class="qr-code-item">
                                <img src="/assets/qr_codes/qr2.svg" alt="CÃ³digo QR 2">
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="asignaturas">
                <h2>ASIGNATURAS EVALUADAS Y PUNTAJES ALCANZADOS</h2>
                <div class="grafico">
                    <canvas id="graficoBarras"></canvas>
                </div>
                <table class="tabla-resultados">
                    <thead>
                        <tr>
                            <th class="header-nivel"></th>
                            <th class="header-materia">Lectura CrÃ­tica</th>
                            <th class="header-materia">MatemÃ¡ticas</th>
                            <th class="header-materia">Ciencias Sociales</th>
                            <th class="header-materia">Ciencias Naturales</th>
                            <th class="header-materia">InglÃ©s</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="fila-puntaje">
                            <td class="celda-nivel">Puntaje</td>
                            <td><input type="number" class="puntaje-input" data-materia="LC" value="100"></td>
                            <td><input type="number" class="puntaje-input" data-materia="MT" value="100"></td>
                            <td><input type="number" class="puntaje-input" data-materia="SC" value="100"></td>
                            <td><input type="number" class="puntaje-input" data-materia="CN" value="100"></td>
                            <td><input type="number" class="puntaje-input" data-materia="IN" value="100"></td>
                        </tr>
                        <tr class="fila-nivel">
                            <td class="celda-nivel">BAJO</td>
                            <td><span class="rango">0 - 35</span></td>
                            <td><span class="rango">0 - 35</span></td>
                            <td><span class="rango">0 - 40</span></td>
                            <td><span class="rango">0 - 40</span></td>
                            <td><span class="rango">A- / A1</span></td>
                        </tr>
                        <tr class="fila-nivel">
                            <td class="celda-nivel">MEDIO</td>
                            <td><span class="rango">36 - 50</span></td>
                            <td><span class="rango">36 - 50</span></td>
                            <td><span class="rango">41 - 55</span></td>
                            <td><span class="rango">41 - 55</span></td>
                            <td><span class="rango">A2</span></td>
                        </tr>
                        <tr class="fila-nivel">
                            <td class="celda-nivel">ALTO</td>
                            <td><span class="rango">51 - 65</span></td>
                            <td><span class="rango">51 - 70</span></td>
                            <td><span class="rango">56 - 70</span></td>
                            <td><span class="rango">56 - 70</span></td>
                            <td><span class="rango">B1</span></td>
                        </tr>
                        <tr class="fila-nivel">
                            <td class="celda-nivel">SUPERIOR</td>
                            <td><span class="rango">66 - 100</span></td>
                            <td><span class="rango">71 - 100</span></td>
                            <td><span class="rango">71 - 100</span></td>
                            <td><span class="rango">71 - 100</span></td>
                            <td><span class="rango">B+</span></td>
                        </tr>
                        <tr class="fila-percentil">
                            <td class="celda-nivel">Percentil General</td>
                            <td colspan="5" class="percentil" style="text-align: center; font-size: 1.2rem;">Su puntaje
                                superÃ³ al <span id="percentilGeneral">100</span>% de estudiantes </td>
                        </tr>
                        <tr class="fila-desempeno">
                            <td class="celda-nivel">Nivel DesempeÃ±o</td>
                            <td class="nivel">4</td>
                            <td class="nivel">4</td>
                            <td class="nivel">3</td>
                            <td class="nivel">4</td>
                            <td class="nivel">B+</td>
                        </tr>
                    </tbody>
                </table>
            </section>
        </div>
    </div>


    <div class="buscador-container">
        <div class="buscador-wrapper">

            <button class="boton-editar" id="botonEditar">
                <i class="fas fa-pencil-alt"></i>
            </button>
            <button class="boton-buscar" id="botonBuscar">
                <i class="fas fa-search-plus"></i>
            </button>
            <div class="buscador-input-container" id="contenedorBuscador">
                <i class="fas fa-search buscador-icono"></i>
                <input type="text" class="buscador-input" id="buscadorEstudiantes"
                    placeholder="Filtrar por nombre o identificaciÃ³n...">
                <div class="resultados-busqueda" id="resultadosBusqueda"></div>
            </div>
        </div>
    </div>

    <!-- BotÃ³n flotante para agregar hojas -->
    <button id="botonAgregar" class="boton-agregar" title="Agregar hoja adicional">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Modal de ediciÃ³n -->
    <div class="overlay" id="overlay"></div>
    <div class="modal-edicion" id="modalEdicion">
        <h2>Editar Puntajes</h2>
        <div class="campo-edicion lc">
            <label>Lectura CrÃ­tica</label>
            <input type="number" id="editLC" min="0" max="100" placeholder="0-100">
            <span class="rango-actual">Rango: 0-100</span>
            <span class="tooltip">Ingrese un valor entre 0 y 100</span>
        </div>
        <div class="campo-edicion mt">
            <label>MatemÃ¡ticas</label>
            <input type="number" id="editMT" min="0" max="100" placeholder="0-100">
            <span class="rango-actual">Rango: 0-100</span>
            <span class="tooltip">Ingrese un valor entre 0 y 100</span>
        </div>
        <div class="campo-edicion sc">
            <label>Ciencias Sociales</label>
            <input type="number" id="editSC" min="0" max="100" placeholder="0-100">
            <span class="rango-actual">Rango: 0-100</span>
            <span class="tooltip">Ingrese un valor entre 0 y 100</span>
        </div>
        <div class="campo-edicion cn">
            <label>Ciencias Naturales</label>
            <input type="number" id="editCN" min="0" max="100" placeholder="0-100">
            <span class="rango-actual">Rango: 0-100</span>
            <span class="tooltip">Ingrese un valor entre 0 y 100</span>
        </div>
        <div class="campo-edicion in">
            <label>InglÃ©s</label>
            <input type="number" id="editIN" min="0" max="100" placeholder="0-100">
            <span class="rango-actual">Rango: 0-100</span>
            <span class="tooltip">Ingrese un valor entre 0 y 100</span>
        </div>
        <div class="botones-modal">
            <button class="boton-modal boton-cancelar" onclick="cerrarModalEdicion()">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="boton-modal boton-guardar" onclick="guardarCambios()">
                <i class="fas fa-save"></i> Guardar
            </button>
        </div>
    </div>

    <script>
        // ConfiguraciÃ³n inicial del grÃ¡fico
        let graficoBarras;

        // Colores para cada materia
        const coloresMateria = {
            'LC': '#FF4D4D',
            'MT': '#33CCFF',
            'SC': '#FF8C00',
            'CN': '#33FF77',
            'IN': '#B366FF'
        };

        // FunciÃ³n para animar nÃºmeros
        function animarNumero(elemento, inicio, fin, duracion) {
            const rango = fin - inicio;
            const incremento = rango / (duracion / 16);
            let actual = inicio;

            const actualizar = () => {
                actual += incremento;
                if ((incremento > 0 && actual >= fin) || (incremento < 0 && actual <= fin)) {
                    elemento.textContent = Math.round(fin);
                    return;
                }
                elemento.textContent = Math.round(actual);
                requestAnimationFrame(actualizar);
            };

            requestAnimationFrame(actualizar);
        }

        // FunciÃ³n para convertir puntaje de 0-100 a 0-500
        function convertirA500(puntaje) {
            return Math.round((puntaje * 5));
        }

        // FunciÃ³n para convertir puntaje de 0-500 a 0-100
        function convertirA100(puntaje) {
            return Math.round((puntaje / 5));
        }

        // FunciÃ³n para calcular puntaje global
        function calcularPuntajeGlobal() {
            const puntajes = Array.from(document.querySelectorAll('.puntaje-input')).map(input => parseInt(input.value) || 0);

            // Multiplicar cada puntaje por su ponderaciÃ³n
            const ponderaciones = [3, 3, 3, 3, 1]; // LC, MT, SC, CN, IN
            const puntajesPonderados = puntajes.map((puntaje, index) => puntaje * ponderaciones[index]);

            // Sumar todos los puntajes ponderados
            const sumaPonderada = puntajesPonderados.reduce((a, b) => a + b, 0);

            // Dividir por la suma de ponderaciones (13) y multiplicar por 5
            const puntajeGlobal = Math.round((sumaPonderada / 13) * 5);

            return puntajeGlobal;
        }

        // FunciÃ³n para actualizar el puntaje global
        function actualizarPuntajeGlobal() {
            const puntajeGlobal = calcularPuntajeGlobal();
            const elementoPuntaje = document.getElementById('puntajeGlobal');
            elementoPuntaje.textContent = puntajeGlobal;
        }

        // FunciÃ³n para actualizar el rango activo
        function actualizarRangoActivo(input) {
            const valor = parseInt(input.value) || 0;
            const fila = input.closest('tr');
            const columna = Array.from(fila.cells).indexOf(input.closest('td'));
            const tabla = input.closest('table');
            const rangos = Array.from(tabla.querySelectorAll('.fila-nivel')).slice(0, 4);

            // Remover clase activo de todos los rangos en esta columna
            rangos.forEach(fila => {
                const celda = fila.cells[columna];
                celda.querySelector('.rango')?.classList.remove('activo');
            });

            // Definir umbrales por columna (Materia)
            // Indices: 1:LC, 2:MT, 3:SC, 4:CN, 5:IN
            // Formato: [LimiteBajo, LimiteMedio, LimiteAlto] (Superiores cae en else)
            const umbrales = {
                1: [35, 50, 65], // Lectura CrÃ­tica
                2: [35, 50, 70], // MatemÃ¡ticas
                3: [40, 55, 70], // Sociales
                4: [40, 55, 70], // Ciencias
                5: [57, 70, 85]  // InglÃ©s (Ajustado visual: >85 para B+)
            };

            const limites = umbrales[columna] || [39, 59, 79]; // Fallback

            // AÃ±adir clase activo al rango correspondiente
            let rangoActivo;
            if (valor <= limites[0]) rangoActivo = rangos[0];      // Bajo
            else if (valor <= limites[1]) rangoActivo = rangos[1]; // Medio
            else if (valor <= limites[2]) rangoActivo = rangos[2]; // Alto
            else rangoActivo = rangos[3];                          // Superior

            if (rangoActivo) {
                const celda = rangoActivo.cells[columna];
                const rango = celda.querySelector('.rango');
                if (rango) rango.classList.add('activo');

                // Actualizar texto de nivel en la Ãºltima fila
                const filaDesempeno = tabla.querySelector('.fila-desempeno');
                if (filaDesempeno) {
                    const celdaNivel = filaDesempeno.cells[columna];
                    let textoNivel = '';

                    // Columna 5 es InglÃ©s (Ã­ndice 5 en array de celdas incluye th/td inicial)
                    // La primera columna es Ã­ndice 0 (celda-nivel etiqueta), luego 1=LC, 2=MT, ... 5=IN
                    // Ojo: en 'rangos' la celda 0 es la etiqueta.

                    if (columna === 5) { // InglÃ©s
                        if (rangoActivo === rangos[0]) textoNivel = 'A- / A1';
                        else if (rangoActivo === rangos[1]) textoNivel = 'A2';
                        else if (rangoActivo === rangos[2]) textoNivel = 'B1';
                        else textoNivel = 'B+';
                    } else { // Otras materias
                        if (rangoActivo === rangos[0]) textoNivel = '1';
                        else if (rangoActivo === rangos[1]) textoNivel = '2';
                        else if (rangoActivo === rangos[2]) textoNivel = '3';
                        else textoNivel = '4';
                    }

                    if (celdaNivel) celdaNivel.textContent = textoNivel;
                }
            }
        }

        // FunciÃ³n para actualizar el grÃ¡fico
        function actualizarGrafico() {
            const datos = Array.from(document.querySelectorAll('.puntaje-input')).map(input => ({
                materia: input.dataset.materia,
                puntaje: parseInt(input.value) || 0
            }));

            graficoBarras.data.datasets[0].data = datos.map(d => d.puntaje);
            graficoBarras.update('active');
            actualizarPuntajeGlobal();
        }

        // FunciÃ³n para inicializar el grÃ¡fico
        function inicializarGrafico() {
            const ctx = document.getElementById('graficoBarras').getContext('2d');
            const materias = ['Lectura CrÃ­tica', 'MatemÃ¡ticas', 'Ciencias Sociales', 'Ciencias Naturales', 'InglÃ©s'];
            const puntajes = Array.from(document.querySelectorAll('.puntaje-input')).map(input => parseInt(input.value) || 0);
            const colores = Object.values(coloresMateria);

            graficoBarras = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: materias,
                    datasets: [{
                        label: 'Puntaje por Materia',
                        data: puntajes,
                        backgroundColor: colores,
                        borderColor: colores,
                        borderWidth: 2,
                        borderRadius: {
                            topLeft: 10,
                            topRight: 10
                        },
                        maxBarThickness: 75,
                        minBarLength: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0 // Eliminar la animaciÃ³n
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.08)'
                            },
                            ticks: {
                                stepSize: 10,
                                font: {
                                    size: 12
                                },
                                callback: function (value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // FunciÃ³n para calcular percentil general
        function calcularPercentilGeneral() {
            const puntajes = Array.from(document.querySelectorAll('.puntaje-input')).map(input => parseInt(input.value) || 0);
            const puntajePromedio = puntajes.reduce((a, b) => a + b, 0) / puntajes.length;

            if (puntajePromedio >= 80) return 100;
            if (puntajePromedio >= 60) return 93;
            if (puntajePromedio >= 40) return 75;
            return 50;
        }

        // FunciÃ³n para actualizar percentil general
        function actualizarPercentilGeneral() {
            const percentil = calcularPercentilGeneral();
            document.getElementById('percentilGeneral').textContent = percentil;
        }

        // FunciÃ³n para calcular nivel de desempeÃ±o
        function calcularNivelDesempeno(puntaje, esIngles = false) {
            if (esIngles) {
                if (puntaje >= 80) return 'B+';
                if (puntaje >= 60) return 'B1';
                if (puntaje >= 40) return 'A2';
                return 'A- / A1';
            }
            if (puntaje <= 39) return '1';
            if (puntaje <= 59) return '2';
            if (puntaje <= 79) return '3';
            return '4';
        }

        // FunciÃ³n para actualizar percentiles y niveles
        function actualizarPercentilYNivel(input) {
            const fila = input.closest('tr');
            const columna = Array.from(fila.cells).indexOf(input.closest('td'));
            const tabla = input.closest('table');
            const valor = parseInt(input.value) || 0;
            const esIngles = columna === 5; // Corregido de 6 a 5 ya que es la quinta columna (Ã­ndice 5)

            // Actualizar percentil general
            actualizarPercentilGeneral();

            // Actualizar nivel de desempeÃ±o
            const filaNivel = tabla.querySelector('.fila-desempeno');
            if (filaNivel) {
                const celdaNivel = filaNivel.cells[columna];
                if (celdaNivel) {
                    celdaNivel.textContent = calcularNivelDesempeno(valor, esIngles);
                }
            }
        }

        // FunciÃ³n para actualizar el color segÃºn el nivel
        function actualizarNivelVisual(input) {
            const valor = parseInt(input.value) || 0;
            input.classList.remove('nivel-bajo', 'nivel-medio', 'nivel-alto', 'nivel-superior');

            if (valor <= 39) {
                input.classList.add('nivel-bajo');
            } else if (valor <= 59) {
                input.classList.add('nivel-medio');
            } else if (valor <= 79) {
                input.classList.add('nivel-alto');
            } else {
                input.classList.add('nivel-superior');
            }
        }

        // Actualizar los eventos de los inputs
        document.querySelectorAll('.puntaje-input').forEach(input => {
            input.addEventListener('input', (e) => {
                let valor = parseInt(e.target.value) || 0;
                valor = Math.max(0, Math.min(100, valor));
                e.target.value = valor;

                actualizarRangoActivo(e.target);
                actualizarGrafico();
                actualizarPercentilYNivel(e.target);
                actualizarNivelVisual(e.target);
            });

            actualizarRangoActivo(input);
            actualizarNivelVisual(input);
        });

        // FunciÃ³n para formatear el nombre con iniciales en mayÃºsculas
        function formatearNombrePDF(nombre) {
            return nombre.split(' ')
                .map(palabra => palabra.charAt(0).toUpperCase() + palabra.slice(1).toLowerCase())
                .join(' ');
        }

        // FunciÃ³n para validar las secciones del estudiante
        function validarSeccionesEstudiante() {
            const puntajes = {
                'LC': parseInt(document.querySelector('.puntaje-input[data-materia="LC"]').value) || 0,
                'MT': parseInt(document.querySelector('.puntaje-input[data-materia="MT"]').value) || 0,
                'SC': parseInt(document.querySelector('.puntaje-input[data-materia="SC"]').value) || 0,
                'CN': parseInt(document.querySelector('.puntaje-input[data-materia="CN"]').value) || 0,
                'IN': parseInt(document.querySelector('.puntaje-input[data-materia="IN"]').value) || 0
            };

            // Verificar si falta inglÃ©s (secciÃ³n 2)
            if (puntajes.IN === 0) {
                mostrarAlerta(
                    'SecciÃ³n Faltante',
                    'Este estudiante no tiene la secciÃ³n 2 (InglÃ©s) registrada. No se puede generar el informe.',
                    'error'
                );
                return false;
            }

            // Verificar si faltan otras materias (secciÃ³n 1)
            const materiasIncompletas = ['LC', 'MT', 'SC', 'CN'].filter(materia => puntajes[materia] === 0);
            if (materiasIncompletas.length > 0) {
                mostrarAlerta(
                    'SecciÃ³n Faltante',
                    'Este estudiante no tiene la secciÃ³n 1 completa. No se puede generar el informe.',
                    'error'
                );
                return false;
            }

            return true;
        }

        // Modificar la funciÃ³n descargarPDF
        function descargarPDF() {
            if (!validarSeccionesEstudiante()) {
                return Promise.reject('ValidaciÃ³n fallida');
            }
            // Guardar la posiciÃ³n actual del scroll
            const scrollPos = window.scrollY;

            // Mover la pÃ¡gina al inicio
            window.scrollTo(0, 0);

            // Obtener todas las hojas (la principal y las adicionales)
            const contenedor = document.querySelector('.contenedor-principal');
            const nombreEstudiante = formatearNombrePDF(document.getElementById('nombreEstudiante').value);
            const tipoDoc = document.getElementById('tipoDocumento').value;
            const numDoc = document.getElementById('identificacionEstudiante').value;

            const nombreArchivo = `${nombreEstudiante} - ${numDoc}.pdf`;

            // Aplicar clase especial para impresiÃ³n
            document.body.classList.add('modo-impresion');

            // ConfiguraciÃ³n para html2pdf
            const opciones = {
                margin: [0, 0, 0, 0],
                filename: nombreArchivo,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2,
                    scrollY: 0,
                    windowHeight: document.documentElement.scrollHeight,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    ignoreElements: function (element) {
                        return element.classList.contains('boton-eliminar-hoja');
                    },
                    onclone: function (clonedDoc) {
                        // Asegurar que todos los elementos en el documento clonado sean visibles
                        const elementosClonados = clonedDoc.querySelectorAll('*');
                        elementosClonados.forEach(elemento => {
                            elemento.style.opacity = '1';
                            elemento.style.visibility = 'visible';
                            if (elemento.tagName === 'CANVAS') {
                                elemento.style.background = 'white';
                                elemento.style.display = 'block';
                            }
                        });

                        // Asegurar que las hojas adicionales sean visibles
                        const hojasClonadas = clonedDoc.querySelectorAll('.hoja-adicional');
                        hojasClonadas.forEach(hoja => {
                            hoja.style.opacity = '1';
                            hoja.style.visibility = 'visible';
                            hoja.style.display = 'block';
                            hoja.style.background = 'white';
                        });
                    }
                },
                jsPDF: {
                    unit: 'mm',
                    format: 'legal',
                    orientation: 'portrait',
                    compress: true
                },
                pagebreak: { mode: 'avoid-all', before: '.pagebreak' }
            };

            // Hacer visibles todas las hojas adicionales para la impresiÃ³n y ocultar botones de eliminar
            document.querySelectorAll('.hoja-adicional').forEach(hoja => {
                hoja.style.opacity = '1';
                hoja.style.visibility = 'visible';
                hoja.style.display = 'block';
                hoja.style.background = 'white';

                // Asegurar que todos los elementos internos sean visibles
                const elementosInternos = hoja.querySelectorAll('*');
                elementosInternos.forEach(elemento => {
                    elemento.style.opacity = '1';
                    elemento.style.visibility = 'visible';
                    if (elemento.tagName === 'CANVAS') {
                        elemento.style.background = 'white';
                        elemento.style.display = 'block';
                    }
                });

                // Ocultar el botÃ³n de eliminar en cada hoja
                const botonEliminar = hoja.querySelector('.boton-eliminar-hoja');
                if (botonEliminar) {
                    botonEliminar.style.display = 'none';
                    botonEliminar.style.visibility = 'hidden';
                    botonEliminar.style.opacity = '0';
                }
            });

            // Generar el PDF incluyendo todas las hojas
            let pdf = html2pdf().set(opciones).from(contenedor);

            // Restaurar la posiciÃ³n del scroll y quitar clase de impresiÃ³n despuÃ©s
            pdf.save().then(() => {
                document.body.classList.remove('modo-impresion');
                window.scrollTo(0, scrollPos);
            });

            return pdf;
        }

        // Modificar la funciÃ³n iniciarDescargaAutomatica
        async function iniciarDescargaAutomatica() {
            const modo = document.getElementById('modoDescarga').value;
            if (modo !== 'automatico') {
                mostrarAlerta('Modo Incorrecto', 'Por favor, seleccione el modo automÃ¡tico para usar esta funciÃ³n', 'warning');
                return;
            }

            const inicio = parseInt(document.getElementById('inicioRango').value);
            const fin = parseInt(document.getElementById('finRango').value);

            if (isNaN(inicio) || isNaN(fin) || inicio < 0 || fin < inicio || fin >= datosEstudiantes.length) {
                mostrarAlerta('Rango InvÃ¡lido', 'Por favor, seleccione un rango vÃ¡lido de estudiantes', 'error');
                return;
            }

            // Guardar las hojas adicionales del estudiante actual
            const hojasAdicionales = guardarHojasAdicionales();

            const botonDescarga = document.querySelector('.rango-descarga .boton-descarga');
            const textoOriginal = botonDescarga.innerHTML;
            botonDescarga.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Descargando...';
            botonDescarga.disabled = true;

            try {
                let progreso = 0;
                const total = fin - inicio + 1;
                let estudiantesOmitidos = [];

                for (let i = inicio; i <= fin; i++) {
                    // Actualizar los campos con los datos del estudiante actual
                    actualizarCamposEstudiante(datosEstudiantes[i]);

                    // Restaurar las hojas adicionales para este estudiante
                    restaurarHojasAdicionales(hojasAdicionales);

                    // Mostrar progreso
                    progreso++;

                    // Validar secciones antes de intentar descargar
                    if (!validarSeccionesEstudiante()) {
                        estudiantesOmitidos.push({
                            nombre: document.getElementById('nombreEstudiante').value,
                            indice: i + 1
                        });
                        continue; // Saltar al siguiente estudiante
                    }

                    // Esperar a que se actualicen los datos y el grÃ¡fico
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    // Descargar el PDF
                    await descargarPDF();

                    // Esperar antes de continuar con el siguiente estudiante
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }

                // Mostrar resumen de la operaciÃ³n
                if (estudiantesOmitidos.length > 0) {
                    const mensajeOmitidos = estudiantesOmitidos
                        .map(e => `${e.indice}. ${e.nombre}`)
                        .join('\n');

                    mostrarAlerta(
                        'Descarga Parcialmente Completada',
                        `Se han omitido los siguientes estudiantes por falta de secciones:\n\n${mensajeOmitidos}`,
                        'warning'
                    );
                } else {
                    mostrarAlerta(
                        'Descarga Completada',
                        `Se han descargado exitosamente los PDFs de los estudiantes ${inicio + 1} a ${fin + 1}`,
                        'success'
                    );
                }
            } catch (error) {
                console.error('Error durante la descarga automÃ¡tica:', error);
                mostrarAlerta(
                    'Error en la Descarga',
                    `OcurriÃ³ un error durante la descarga automÃ¡tica: ${error.message}`,
                    'error'
                );
            } finally {
                botonDescarga.innerHTML = textoOriginal;
                botonDescarga.disabled = false;
            }
        }

        // FunciÃ³n para guardar las hojas adicionales actuales
        function guardarHojasAdicionales() {
            // Obtener todas las hojas adicionales
            const hojasAdicionales = document.querySelectorAll('.hoja-adicional');
            if (hojasAdicionales.length === 0) return null;

            // Guardar el contenido de cada hoja
            return Array.from(hojasAdicionales).map(hoja => {
                return {
                    contenido: hoja.querySelector('.contenido-adicional').innerHTML
                };
            });
        }

        // FunciÃ³n para restaurar las hojas adicionales guardadas
        function restaurarHojasAdicionales(hojasGuardadas) {
            // Eliminar todas las hojas adicionales actuales
            document.querySelectorAll('.hoja-adicional').forEach(hoja => hoja.remove());

            // Si no hay hojas guardadas, terminar
            if (!hojasGuardadas || hojasGuardadas.length === 0) return;

            // Recrear las hojas adicionales
            hojasGuardadas.forEach(hojaGuardada => {
                agregarNuevaHoja();
                const nuevaHoja = document.querySelector('.hoja-adicional:last-child');
                nuevaHoja.querySelector('.contenido-adicional').innerHTML = hojaGuardada.contenido;
            });
        }

        // FunciÃ³n para reajustar puntajes segÃºn la fÃ³rmula especificada
        function reajustarPuntaje(puntaje) {
            let puntajeReajustado;
            if (puntaje === 100) {
                puntajeReajustado = 100;
            } else if (puntaje <= 25) {
                puntajeReajustado = 21 + (puntaje / 25) * 9;
            } else if (puntaje <= 87) {
                puntajeReajustado = puntaje;
            } else {
                puntajeReajustado = 76 + ((puntaje - 88) / 11) * 10;
            }
            return Math.round(puntajeReajustado);
        }

        // Modificar la funciÃ³n actualizarCamposEstudiante para validar al cargar
        function actualizarCamposEstudiante(estudiante) {
            if (!estudiante) return;

            document.getElementById('nombreEstudiante').value = formatearNombre(`${estudiante.informacion_personal.nombres} ${estudiante.informacion_personal.apellidos}`);

            // Eliminar solo las hojas adicionales del estudiante anterior (preservar estadÃ­sticas grupales)
            document.querySelectorAll('.hoja-adicional').forEach(hoja => {
                // Preservar las hojas de estadÃ­sticas (tienen ID que empieza con 'estadistica_')
                if (!hoja.id || !hoja.id.startsWith('estadistica_')) {
                    hoja.remove();
                }
            });

            // Actualizar la fecha en el campo principal
            const fecha = estudiante.fecha ? new Date(estudiante.fecha).toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
            document.getElementById('fechaAplicacion').value = fecha;

            // Resto del cÃ³digo existente...
            document.getElementById('telefonoEstudiante').value = estudiante.informacion_personal.telefono;

            // Actualizar departamento con validaciÃ³n
            const departamentoEstudiante = estudiante.informacion_personal.municipio || "";
            const departamentoSelect = document.getElementById('municipioEstudiante');

            if (esDepartamentoValido(departamentoEstudiante)) {
                // Buscar la opciÃ³n que coincida (ignorando mayÃºsculas/minÃºsculas y tildes)
                const normalizarTexto = (texto) => {
                    return texto.toLowerCase()
                        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                        .replace(/Ã±/g, "n")
                        .trim();
                };

                const departamentoNormalizado = normalizarTexto(departamentoEstudiante);
                let encontrado = false;

                for (let i = 0; i < departamentoSelect.options.length; i++) {
                    if (normalizarTexto(departamentoSelect.options[i].text) === departamentoNormalizado) {
                        departamentoSelect.selectedIndex = i;
                        encontrado = true;
                        break;
                    }
                }

                if (!encontrado) {
                    // Si no se encuentra, establecer "No aplica"
                    departamentoSelect.value = "No aplica";
                }
            } else {
                // Si no es vÃ¡lido, establecer "No aplica"
                departamentoSelect.value = "No aplica";
            }

            const tipoDocumentoMap = {
                'T.I.': 'TI',
                'C.C.': 'CC',
                'C.E.': 'CE',
                'PA.': 'PA',
                'NIT.': 'NIT'
            };

            const tipoDocCompleto = estudiante.informacion_personal.tipo_identificacion.split(' ')[0];
            const tipoDoc = tipoDocumentoMap[tipoDocCompleto] || tipoDocCompleto;
            document.getElementById('tipoDocumento').value = tipoDoc;
            document.getElementById('identificacionEstudiante').value = estudiante.informacion_personal.numero_identificacion;

            const tipoEstudianteMap = {
                'ESTUDIANTE': 'ESTUDIANTE',
                'INDIVIDUAL/REPITENTE': 'INDIV/REP',
                'PRESABER': 'PRESABER',
                'VALIDANTE': 'VALIDANTE'
            };
            const tipoEstudiante = tipoEstudianteMap[estudiante.tipo] || estudiante.tipo;
            document.getElementById('calEstudiante').value = tipoEstudiante;

            // Obtener puntajes originales
            const puntajesOriginales = {
                'LC': estudiante.puntajes['lectura crítica']?.puntaje || 0,
                'MT': estudiante.puntajes['matemáticas']?.puntaje || 0,
                'SC': estudiante.puntajes['sociales y ciudadanas']?.puntaje || 0,
                'CN': estudiante.puntajes['ciencias naturales']?.puntaje || 0,
                'IN': estudiante.puntajes['inglés']?.puntaje || 0
            };

            // Aplicar reajuste a los puntajes
            const puntajesReajustados = {
                'LC': reajustarPuntaje(puntajesOriginales['LC']),
                'MT': reajustarPuntaje(puntajesOriginales['MT']),
                'SC': reajustarPuntaje(puntajesOriginales['SC']),
                'CN': reajustarPuntaje(puntajesOriginales['CN']),
                'IN': reajustarPuntaje(puntajesOriginales['IN'])
            };

            // Calcular promedio de los puntajes reajustados
            const puntajesArray = Object.values(puntajesReajustados);
            const promedio = Math.round(puntajesArray.reduce((a, b) => a + b, 0) / puntajesArray.length);

            // Actualizar los campos con los puntajes reajustados
            document.querySelectorAll('.puntaje-input').forEach(input => {
                const materia = input.dataset.materia;
                input.value = puntajesReajustados[materia]; // Ya estÃ¡ redondeado por la funciÃ³n reajustarPuntaje
                actualizarRangoActivo(input);
                actualizarPercentilYNivel(input);
                actualizarNivelVisual(input);
            });

            // Actualizar puntaje global con el promedio
            document.getElementById('puntajeGlobal').textContent = promedio;

            actualizarGrafico();

            // Validar secciones al cargar y mostrar alerta si es necesario
            const faltaIngles = puntajesOriginales['IN'] === 0;
            const faltaSeccion1 = ['LC', 'MT', 'SC', 'CN'].some(materia => puntajesOriginales[materia] === 0);

            if (faltaIngles || faltaSeccion1) {
                const nombreEstudiante = document.getElementById('nombreEstudiante').value;
                const mensaje = faltaIngles ?
                    'Este estudiante no tiene la secciÃ³n 2 (InglÃ©s) registrada.' :
                    'Este estudiante no tiene la secciÃ³n 1 completa.';

                mostrarAlerta(
                    'Advertencia',
                    `${mensaje}\nNo se podrÃ¡ generar el informe para ${nombreEstudiante}.`,
                    'warning'
                );
            }
        }

        // Evento para el selector de estudiantes
        document.getElementById('selectorEstudiante').addEventListener('change', (e) => {
            const indice = parseInt(e.target.value);
            if (indice >= 0 && datosEstudiantes[indice]) {
                actualizarCamposEstudiante(datosEstudiantes[indice]);
            }
        });

        // Inicializar cuando se carga la pÃ¡gina
        document.addEventListener('DOMContentLoaded', () => {
            cargarDatosEstudiantes();
            inicializarGrafico();
            inicializarBuscador();
            cargarSimulacros(); // Cargar lista de simulacros

            // Configurar el campo SG11
            const sg11Input = document.getElementById('sg11Numero');
            sg11Input.addEventListener('input', (e) => {
                // Permitir solo nÃºmeros
                e.target.value = e.target.value.replace(/[^0-9]/g, '');

                // Limitar a 4 dÃ­gitos
                if (e.target.value.length > 4) {
                    e.target.value = e.target.value.slice(0, 4);
                }
            });
        });

        // Función para cargar la lista de simulacros
        function cargarSimulacros() {
            fetch('/api/simulacros')
                .then(response => response.json())
                .then(data => {
                    const selector = document.getElementById('selectorSimulacro');
                    const estadoSpan = document.getElementById('estadoSimulacro');

                    selector.innerHTML = '<option value="">Seleccionar Simulacro</option>';

                    if (data.simulacros && data.simulacros.length > 0) {
                        data.simulacros.forEach(sim => {
                            const option = document.createElement('option');
                            option.value = sim.id;
                            const estado = sim.procesado ? '✓' : (sim.listo ? '⏳' : '❌');
                            option.textContent = `${sim.id} ${estado}`;
                            option.dataset.listo = sim.listo;
                            option.dataset.procesado = sim.procesado;
                            selector.appendChild(option);
                        });

                        if (data.simulacro_actual) {
                            selector.value = data.simulacro_actual;
                            actualizarEstadoSimulacro(data.simulacros.find(s => s.id === data.simulacro_actual));
                        }
                    }
                })
                .catch(error => console.error('Error cargando simulacros:', error));
        }

        function actualizarEstadoSimulacro(sim) {
            const estadoSpan = document.getElementById('estadoSimulacro');
            const boton = document.getElementById('botonProcesar');

            if (!sim) {
                estadoSpan.textContent = '';
                boton.disabled = true;
                boton.style.opacity = '0.5';
                return;
            }

            if (sim.procesado) {
                estadoSpan.textContent = '✓ Procesado';
                estadoSpan.style.color = '#22c55e';
            } else if (sim.listo) {
                estadoSpan.textContent = '⏳ Listo';
                estadoSpan.style.color = '#f59e0b';
            } else {
                estadoSpan.textContent = '❌ Incompleto';
                estadoSpan.style.color = '#ef4444';
            }

            boton.disabled = false;
            boton.style.opacity = '1';
        }

        document.getElementById('selectorSimulacro').addEventListener('change', function (e) {
            const simulacroId = e.target.value;
            const boton = document.getElementById('botonProcesar');

            if (!simulacroId) {
                document.getElementById('estadoSimulacro').textContent = '';
                boton.disabled = true;
                boton.style.opacity = '0.5';
                return;
            }

            fetch('/api/simulacros/seleccionar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ simulacro_id: simulacroId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        fetch('/api/simulacros')
                            .then(r => r.json())
                            .then(simData => {
                                const sim = simData.simulacros.find(s => s.id === simulacroId);
                                actualizarEstadoSimulacro(sim);
                            });
                    }
                });
        });

        // Manejo del formulario de archivos
        document.getElementById('formulario-archivos').addEventListener('submit', function (e) {
            e.preventDefault();

            const simulacroId = document.getElementById('selectorSimulacro').value;
            if (!simulacroId) {
                mostrarAlerta('Error', 'Debe seleccionar un simulacro antes de procesar', 'warning');
                return;
            }

            mostrarAlerta('Procesando', 'Procesando ' + simulacroId + '...', 'info');

            fetch('/api/simulacros/procesar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ simulacro_id: simulacroId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        mostrarAlerta('Error', data.error, 'error');
                    } else {
                        mostrarAlerta('Éxito', data.mensaje + ' (' + data.total_estudiantes + ' estudiantes)', 'success');
                        cargarDatosEstudiantes();
                        cargarSimulacros();
                    }
                })
                .catch(error => {
                    mostrarAlerta('Error', error.message, 'error');
                });
        });

        // Actualizar el texto de los labels cuando se selecciona un archivo
        document.querySelectorAll('.archivo-input-menu input[type="file"]').forEach(input => {
            input.addEventListener('change', function () {
                const label = this.nextElementSibling;
                const icon = label.querySelector('i');
                const textoEstado = label.querySelector('.texto-estado');

                if (this.files[0]) {
                    label.classList.add('archivo-cargado');
                    icon.className = 'fas fa-check-circle';
                    textoEstado.textContent = 'âœ“';
                } else {
                    label.classList.remove('archivo-cargado');
                    icon.className = 'fas fa-file-excel';
                    textoEstado.textContent = '';
                }
            });
        });

        // FunciÃ³n para cambiar el modo de descarga
        function cambiarModoDescarga() {
            const modo = document.getElementById('modoDescarga').value;
            const rangoDescarga = document.querySelector('.rango-descarga');
            const botonDescargaNormal = document.querySelector('.boton-descarga:not(.rango-descarga .boton-descarga)');
            const selectorEstudiante = document.getElementById('selectorEstudiante');

            if (modo === 'automatico') {
                rangoDescarga.classList.add('visible');
                botonDescargaNormal.style.display = 'none';
                // El selector de estudiante permanece visible
                selectorEstudiante.style.display = 'block';
                // Asegurar que los selectores estÃ©n actualizados
                actualizarSelectoresRango();
            } else {
                rangoDescarga.classList.remove('visible');
                botonDescargaNormal.style.display = 'inline-flex';
            }
        }

        // FunciÃ³n para formatear nombres (primera letra mayÃºscula, resto minÃºsculas)
        function formatearNombre(nombre) {
            return nombre.split(' ')
                .map(palabra => palabra.charAt(0).toUpperCase() + palabra.slice(1).toLowerCase())
                .join(' ');
        }

        // FunciÃ³n para validar departamentos
        function esDepartamentoValido(departamento) {
            const departamentosValidos = new Set([
                "Amazonas", "Antioquia", "Arauca", "Atlantico", "Bolivar", "Boyaca",
                "Caldas", "Caqueta", "Casanare", "Cauca", "Cesar", "Choco", "Cordoba",
                "Cundinamarca", "Guainia", "Guaviare", "Huila", "La Guajira", "Magdalena",
                "Meta", "Narino", "Norte de Santander", "Putumayo", "Quindio", "Risaralda",
                "San Andres y Providencia", "Santander", "Sucre", "Tolima", "Valle del Cauca",
                "Vaupes", "Vichada", "Bogota"
            ]);

            // Normalizar el departamento para la comparaciÃ³n
            const normalizarTexto = (texto) => {
                return texto.toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Eliminar tildes
                    .replace(/Ã±/g, "n")
                    .trim();
            };

            const departamentoNormalizado = normalizarTexto(departamento);
            const departamentosNormalizados = new Set(
                Array.from(departamentosValidos).map(d => normalizarTexto(d))
            );

            return departamentosNormalizados.has(departamentoNormalizado);
        }

        // FunciÃ³n para obtener el estudiante actualmente seleccionado
        function obtenerEstudianteActual() {
            const selectorEstudiante = document.getElementById('selectorEstudiante');
            const indice = parseInt(selectorEstudiante.value);

            if (indice >= 0 && datosEstudiantes && datosEstudiantes[indice]) {
                return datosEstudiantes[indice];
            }

            return null;
        }

        // FunciÃ³n para actualizar los selectores de rango
        function actualizarSelectoresRango() {
            const inicioSelect = document.getElementById('inicioRango');
            const finSelect = document.getElementById('finRango');

            // Limpiar opciones existentes
            inicioSelect.innerHTML = '<option value="">Inicio</option>';
            finSelect.innerHTML = '<option value="">Fin</option>';

            // Verificar si hay datos de estudiantes
            if (!datosEstudiantes || datosEstudiantes.length === 0) {
                console.log('No hay datos de estudiantes para cargar en los selectores');
                return;
            }

            // Agregar opciones para cada estudiante
            datosEstudiantes.forEach((estudiante, index) => {
                const nombreCompleto = formatearNombre(`${estudiante.informacion_personal.nombres} ${estudiante.informacion_personal.apellidos}`);

                // Crear opciÃ³n para selector de inicio
                const optionInicio = document.createElement('option');
                optionInicio.value = index;
                optionInicio.textContent = `${index + 1}. ${nombreCompleto}`;
                inicioSelect.appendChild(optionInicio);

                // Crear opciÃ³n para selector de fin
                const optionFin = document.createElement('option');
                optionFin.value = index;
                optionFin.textContent = `${index + 1}. ${nombreCompleto}`;
                finSelect.appendChild(optionFin);
            });
        }

        // Modificar la funciÃ³n cargarDatosEstudiantes
        async function cargarDatosEstudiantes() {
            try {
                const respuesta = await fetch('cargar/resultados_finales.json');
                if (!respuesta.ok) {
                    throw new Error('Error al cargar los datos');
                }

                const datos = await respuesta.json();
                if (!datos || !datos.estudiantes) {
                    throw new Error('Formato de datos invÃ¡lido');
                }

                datosEstudiantes = datos.estudiantes;

                // Llenar el selector de estudiantes
                const selector = document.getElementById('selectorEstudiante');
                selector.innerHTML = '<option value="">Seleccione un estudiante</option>';

                datosEstudiantes.forEach((estudiante, index) => {
                    const nombreCompleto = formatearNombre(`${estudiante.informacion_personal.nombres} ${estudiante.informacion_personal.apellidos}`);
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${index + 1}. ${nombreCompleto}`;
                    selector.appendChild(option);
                });

                // Actualizar los selectores de rango
                actualizarSelectoresRango();

                console.log('Datos cargados exitosamente:', datosEstudiantes.length, 'estudiantes');
            } catch (error) {
                console.error('Error al cargar los datos:', error);
                mostrarAlerta(
                    'Error de Carga',
                    'No se pudieron cargar los datos de los estudiantes. Por favor, verifique que los archivos estÃ©n correctamente cargados.',
                    'error'
                );
            }
        }

        // FunciÃ³n para mostrar alertas personalizadas
        function mostrarAlerta(titulo, mensaje, tipo = 'info') {
            return Swal.fire({
                title: titulo,
                text: mensaje,
                icon: tipo,
                confirmButtonText: 'Aceptar',
                confirmButtonColor: '#FF4D4D',
                background: '#1a1a1a',
                color: '#ffffff',
                backdrop: 'rgba(0,0,0,0.8)',
                customClass: {
                    popup: 'swal2-popup-custom',
                    title: 'swal2-title-custom',
                    content: 'swal2-content-custom',
                    confirmButton: 'swal2-confirm-custom'
                }
            });
        }

        // FunciÃ³n para el buscador de estudiantes
        function inicializarBuscador() {
            const buscador = document.getElementById('buscadorEstudiantes');
            const resultados = document.getElementById('resultadosBusqueda');
            let timeoutId;

            buscador.addEventListener('input', () => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    const busqueda = buscador.value.toLowerCase();
                    if (busqueda.length < 2) {
                        resultados.innerHTML = '';
                        resultados.classList.remove('visible');
                        return;
                    }

                    const estudiantesFiltrados = datosEstudiantes.filter(estudiante => {
                        const nombreCompleto = `${estudiante.informacion_personal.nombres} ${estudiante.informacion_personal.apellidos}`.toLowerCase();
                        const identificacion = estudiante.informacion_personal.numero_identificacion.toString();
                        return nombreCompleto.includes(busqueda) || identificacion.includes(busqueda);
                    });

                    mostrarResultados(estudiantesFiltrados);
                }, 300);
            });

            // Cerrar resultados al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!buscador.contains(e.target) && !resultados.contains(e.target)) {
                    resultados.classList.remove('visible');
                }
            });
        }

        function mostrarResultados(estudiantes) {
            const resultados = document.getElementById('resultadosBusqueda');
            resultados.innerHTML = '';

            if (estudiantes.length === 0) {
                const noResultados = document.createElement('div');
                noResultados.className = 'resultado-item';
                noResultados.innerHTML = '<div class="nombre">No se encontraron resultados</div>';
                resultados.appendChild(noResultados);
            } else {
                estudiantes.forEach((estudiante, index) => {
                    const nombreCompleto = formatearNombre(`${estudiante.informacion_personal.nombres} ${estudiante.informacion_personal.apellidos}`);
                    const elemento = document.createElement('div');
                    elemento.className = 'resultado-item';
                    elemento.innerHTML = `
                        <div class="nombre">${nombreCompleto}</div>
                        <div class="identificacion">${estudiante.informacion_personal.tipo_identificacion} ${estudiante.informacion_personal.numero_identificacion}</div>
                    `;

                    elemento.addEventListener('click', () => {
                        const indiceOriginal = datosEstudiantes.findIndex(e =>
                            e.informacion_personal.numero_identificacion === estudiante.informacion_personal.numero_identificacion
                        );
                        document.getElementById('selectorEstudiante').value = indiceOriginal;
                        actualizarCamposEstudiante(estudiante);
                        resultados.classList.remove('visible');
                        document.getElementById('buscadorEstudiantes').value = '';
                    });

                    resultados.appendChild(elemento);
                });
            }

            resultados.classList.add('visible');
        }

        // FunciÃ³n para manejar el botÃ³n de bÃºsqueda
        document.getElementById('botonBuscar').addEventListener('click', function () {
            const contenedor = document.getElementById('contenedorBuscador');
            const input = document.getElementById('buscadorEstudiantes');

            if (!contenedor.classList.contains('visible')) {
                contenedor.classList.add('visible');
                input.focus();
            } else {
                contenedor.classList.remove('visible');
                input.value = '';
                document.getElementById('resultadosBusqueda').classList.remove('visible');
            }
        });

        // Cerrar el buscador al hacer clic fuera
        document.addEventListener('click', function (e) {
            const contenedor = document.getElementById('contenedorBuscador');
            const botonBuscar = document.getElementById('botonBuscar');
            const resultados = document.getElementById('resultadosBusqueda');

            if (!contenedor.contains(e.target) && !botonBuscar.contains(e.target)) {
                contenedor.classList.remove('visible');
                document.getElementById('buscadorEstudiantes').value = '';
                resultados.classList.remove('visible');
            }
        });

        // Variables para el modo ediciÃ³n
        let modoEdicion = false;
        const botonEditar = document.getElementById('botonEditar');
        const modalEdicion = document.getElementById('modalEdicion');
        const overlay = document.getElementById('overlay');

        // FunciÃ³n para activar/desactivar modo ediciÃ³n
        botonEditar.addEventListener('click', function () {
            const estudianteSeleccionado = document.getElementById('selectorEstudiante').value;

            if (!estudianteSeleccionado) {
                mostrarAlerta('Error', 'Por favor, seleccione un estudiante primero', 'warning');
                return;
            }

            // Obtener los puntajes originales del JSON
            const puntajesOriginales = {
                LC: datosEstudiantes[estudianteSeleccionado].puntajes['lectura crÃ­tica'].puntaje,
                MT: datosEstudiantes[estudianteSeleccionado].puntajes['matemÃ¡ticas'].puntaje,
                SC: datosEstudiantes[estudianteSeleccionado].puntajes['sociales y ciudadanas'].puntaje,
                CN: datosEstudiantes[estudianteSeleccionado].puntajes['ciencias naturales'].puntaje,
                IN: datosEstudiantes[estudianteSeleccionado].puntajes['inglÃ©s'].puntaje
            };

            // Llenar el modal con los puntajes originales (sin reajuste)
            document.getElementById('editLC').value = puntajesOriginales.LC;
            document.getElementById('editMT').value = puntajesOriginales.MT;
            document.getElementById('editSC').value = puntajesOriginales.SC;
            document.getElementById('editCN').value = puntajesOriginales.CN;
            document.getElementById('editIN').value = puntajesOriginales.IN;

            // Mostrar el modal
            modalEdicion.classList.add('visible');
            overlay.classList.add('visible');
        });

        // FunciÃ³n para cerrar el modal
        function cerrarModalEdicion() {
            modalEdicion.classList.remove('visible');
            overlay.classList.remove('visible');
        }

        // FunciÃ³n para guardar los cambios
        async function guardarCambios() {
            const estudianteSeleccionado = document.getElementById('selectorEstudiante').value;
            if (!estudianteSeleccionado || !datosEstudiantes[estudianteSeleccionado]) {
                mostrarAlerta('Error', 'No se pudo identificar al estudiante', 'error');
                return;
            }

            // Obtener los valores del modal (valores originales)
            const nuevosPuntajes = {
                'lectura crÃ­tica': { puntaje: parseInt(document.getElementById('editLC').value) || 0 },
                'matemÃ¡ticas': { puntaje: parseInt(document.getElementById('editMT').value) || 0 },
                'sociales y ciudadanas': { puntaje: parseInt(document.getElementById('editSC').value) || 0 },
                'ciencias naturales': { puntaje: parseInt(document.getElementById('editCN').value) || 0 },
                'inglÃ©s': { puntaje: parseInt(document.getElementById('editIN').value) || 0 }
            };

            try {
                const respuesta = await fetch('/actualizar-puntajes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        indiceEstudiante: parseInt(estudianteSeleccionado),
                        nuevosPuntajes: nuevosPuntajes
                    })
                });

                if (respuesta.ok) {
                    // Actualizar los datos locales
                    datosEstudiantes[estudianteSeleccionado].puntajes = nuevosPuntajes;

                    // Aplicar el reajuste a los valores para mostrarlos en pantalla
                    document.querySelector('.puntaje-input[data-materia="LC"]').value = reajustarPuntaje(nuevosPuntajes['lectura crÃ­tica'].puntaje);
                    document.querySelector('.puntaje-input[data-materia="MT"]').value = reajustarPuntaje(nuevosPuntajes['matemÃ¡ticas'].puntaje);
                    document.querySelector('.puntaje-input[data-materia="SC"]').value = reajustarPuntaje(nuevosPuntajes['sociales y ciudadanas'].puntaje);
                    document.querySelector('.puntaje-input[data-materia="CN"]').value = reajustarPuntaje(nuevosPuntajes['ciencias naturales'].puntaje);
                    document.querySelector('.puntaje-input[data-materia="IN"]').value = reajustarPuntaje(nuevosPuntajes['inglÃ©s'].puntaje);

                    // Actualizar visualizaciÃ³n
                    actualizarGrafico();
                    actualizarPercentilGeneral();

                    // Actualizar rangos activos y niveles visuales
                    document.querySelectorAll('.puntaje-input').forEach(input => {
                        actualizarRangoActivo(input);
                        actualizarPercentilYNivel(input);
                        actualizarNivelVisual(input);
                    });

                    mostrarAlerta('Ã‰xito', 'Los puntajes se han actualizado correctamente', 'success');
                    cerrarModalEdicion();
                } else {
                    throw new Error('Error al actualizar los puntajes');
                }
            } catch (error) {
                mostrarAlerta('Error', 'No se pudieron guardar los cambios: ' + error.message, 'error');
            }
        }

        // Cerrar modal al hacer clic en el overlay
        overlay.addEventListener('click', cerrarModalEdicion);

        // ValidaciÃ³n de inputs en el modal
        document.querySelectorAll('#modalEdicion input[type="number"]').forEach(input => {
            input.addEventListener('input', function () {
                let valor = parseInt(this.value) || 0;
                valor = Math.max(0, Math.min(100, valor));
                this.value = valor;
            });
        });

        // FunciÃ³n para agregar una nueva hoja
        function agregarNuevaHoja() {
            // Crear una nueva hoja en blanco
            const nuevaHoja = document.createElement('div');
            nuevaHoja.className = 'hoja-adicional';
            nuevaHoja.id = 'documento_' + (document.querySelectorAll('.documento').length + 1);

            // AÃ±adir la marca de agua
            const marcaAgua = document.createElement('div');
            marcaAgua.className = 'marca-agua-container';
            const imgMarca = document.createElement('img');
            imgMarca.src = "/assets/watermarks/marca_de_agua.svg";
            imgMarca.alt = "Marca de agua";
            imgMarca.className = "marca-agua-imagen";
            marcaAgua.appendChild(imgMarca);
            nuevaHoja.appendChild(marcaAgua);

            // AÃ±adir botÃ³n para eliminar esta hoja
            const botonEliminar = document.createElement('button');
            botonEliminar.className = 'boton-eliminar-hoja';
            botonEliminar.innerHTML = '<i class="fas fa-trash"></i>';
            botonEliminar.title = 'Eliminar esta hoja';
            botonEliminar.onclick = function () {
                eliminarHoja(nuevaHoja.id);
            };
            nuevaHoja.appendChild(botonEliminar);

            // AÃ±adir la nueva hoja al contenedor principal
            document.querySelector('.contenedor-principal').appendChild(nuevaHoja);

            // Animar la apariciÃ³n de la nueva hoja
            setTimeout(() => {
                nuevaHoja.style.opacity = '1';
            }, 10);
        }

        // FunciÃ³n para eliminar una hoja especÃ­fica
        function eliminarHoja(idHoja) {
            Swal.fire({
                title: 'Â¿Eliminar hoja?',
                text: 'Â¿EstÃ¡s seguro de que deseas eliminar esta hoja?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#FF4D4D',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'SÃ­, eliminar',
                cancelButtonText: 'Cancelar',
                background: '#1a1a1a',
                color: '#ffffff'
            }).then((result) => {
                if (result.isConfirmed) {
                    const hoja = document.getElementById(idHoja);
                    hoja.style.opacity = '0';
                    setTimeout(() => {
                        hoja.remove();
                    }, 300);
                }
            });
        }

        // FunciÃ³n para guardar las hojas adicionales actuales
        function guardarHojasAdicionales() {
            // Obtener todas las hojas adicionales
            const hojasAdicionales = document.querySelectorAll('.hoja-adicional');
            if (hojasAdicionales.length === 0) return null;

            // Guardar el contenido de cada hoja
            return Array.from(hojasAdicionales).map(hoja => {
                return {
                    contenido: hoja.querySelector('.contenido-adicional').innerHTML
                };
            });
        }

        // FunciÃ³n para restaurar las hojas adicionales guardadas
        function restaurarHojasAdicionales(hojasGuardadas) {
            // Eliminar todas las hojas adicionales actuales
            document.querySelectorAll('.hoja-adicional').forEach(hoja => hoja.remove());

            // Si no hay hojas guardadas, terminar
            if (!hojasGuardadas || hojasGuardadas.length === 0) return;

            // Recrear las hojas adicionales
            hojasGuardadas.forEach(hojaGuardada => {
                agregarNuevaHoja();
                const nuevaHoja = document.querySelector('.hoja-adicional:last-child');
                nuevaHoja.querySelector('.contenido-adicional').innerHTML = hojaGuardada.contenido;
            });
        }

        // Inicializar los eventos para los botones
        document.addEventListener('DOMContentLoaded', function () {
            // Evento para el botÃ³n de agregar hoja
            document.getElementById('botonAgregar').addEventListener('click', function () {
                agregarNuevaHoja();
                // Mostrar mensaje breve de confirmaciÃ³n
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'bottom-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    background: '#222222',
                    color: '#ffffff'
                });

                Toast.fire({
                    icon: 'success',
                    title: 'Hoja adicional agregada'
                });
            });
        });

        // FunciÃ³n para apagar el servidor
        async function apagarServidor() {
            // Primero mostrar una confirmaciÃ³n
            const confirmacion = await Swal.fire({
                title: 'Â¿EstÃ¡s seguro?',
                text: 'El servidor se apagarÃ¡ y la aplicaciÃ³n dejarÃ¡ de funcionar',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#FF4D4D',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'SÃ­, apagar',
                cancelButtonText: 'Cancelar',
                background: '#1a1a1a',
                color: '#ffffff'
            });

            if (!confirmacion.isConfirmed) {
                return;
            }

            try {
                const respuesta = await fetch('/apagar', {
                    method: 'POST'
                });

                if (respuesta.ok) {
                    mostrarAlerta('Apagando servidor', 'El servidor se estÃ¡ apagando...', 'success');
                    // Esperar un momento y luego mostrar mensaje final
                    setTimeout(() => {
                        Swal.fire({
                            title: 'Servidor apagado',
                            text: 'Puede cerrar esta ventana',
                            icon: 'success',
                            confirmButtonColor: '#FF4D4D',
                            background: '#1a1a1a',
                            color: '#ffffff'
                        }).then(() => {
                            window.close();
                        });
                    }, 2000);
                } else {
                    throw new Error('Error al apagar el servidor');
                }
            } catch (error) {
                mostrarAlerta('Error', 'No se pudo apagar el servidor: ' + error.message, 'error');
            }
        }

        // Funciones para el botÃ³n de magia
        document.addEventListener('DOMContentLoaded', function () {
            // FunciÃ³n para generar recomendaciones personalizadas
            function generarRecomendaciones(materia, componentesArray, estadisticas) {
                // Base de datos de recomendaciones por componente y materia
                const recomendacionesDB = {
                    'MATEMÃTICAS': {
                        'Ãlgebra Y CÃ¡lculo': {
                            0: 'ðŸŒŸ He analizado tu desempeÃ±o y es impresionante como dominas el Ã¡lgebra. Te sugiero que explores problemas de cÃ¡lculo diferencial y aplicaciones en fÃ­sica para expandir tu conocimiento matemÃ¡tico. Considera resolver problemas de olimpiadas matemÃ¡ticas.',
                            1: 'ðŸ’¡ Noto que tienes una base sÃ³lida en Ã¡lgebra. Para mejorar, te recomiendo practicar factorizaciÃ³n de polinomios complejos y sistemas de ecuaciones. Un enfoque gradual te ayudarÃ¡ a perfeccionar estas habilidades.',
                            2: 'ðŸ” Veo que necesitas fortalecer algunos conceptos algebraicos fundamentales. Te sugiero repasar las propiedades de exponentes y radicales, luego avanzar paso a paso con ecuaciones cuadrÃ¡ticas. La constancia serÃ¡ tu clave del Ã©xito.',
                            3: 'ðŸš€ Identifico oportunidades importantes de mejora en Ã¡lgebra. Te recomiendo comenzar con operaciones bÃ¡sicas con polinomios y practicar despeje de variables diariamente. Cada ejercicio te acercarÃ¡ a tu meta.',
                            'default': 'ðŸŽ¯ Reconozco que el Ã¡lgebra puede ser desafiante al inicio. Mi recomendaciÃ³n es empezar con nÃºmeros reales y sus propiedades, luego avanzar gradualmente. Tu dedicaciÃ³n marcarÃ¡ la diferencia.'
                        },
                        'EstadÃ­stica': {
                            0: 'ðŸ“Š Tu comprensiÃ³n estadÃ­stica es excepcional. Te propongo explorar estadÃ­stica bayesiana y anÃ¡lisis de regresiÃ³n mÃºltiple. PodrÃ­as tambiÃ©n considerar aplicaciones en ciencia de datos.',
                            1: 'ðŸ“ˆ Observo un buen manejo de conceptos estadÃ­sticos bÃ¡sicos. Para el siguiente nivel, practica interpretaciÃ³n de distribuciones normales y cÃ¡lculo de intervalos de confianza.',
                            2: 'ðŸ“‹ Identifico que necesitas reforzar medidas de tendencia central. Mi sugerencia es practicar con datos reales y crear grÃ¡ficos manualmente antes de usar tecnologÃ­a.',
                            3: 'ðŸ”¢ Veo oportunidades de crecimiento en estadÃ­stica bÃ¡sica. Te recomiendo empezar organizando datos simples en tablas de frecuencia y construyendo grÃ¡ficos paso a paso.',
                            'default': 'ðŸ“Š La estadÃ­stica requiere prÃ¡ctica constante. Mi consejo es comenzar con conceptos de poblaciÃ³n y muestra, luego avanzar gradualmente hacia medidas descriptivas.'
                        },
                        'GeometrÃ­a': {
                            0: 'ðŸ—ï¸ Tu dominio geomÃ©trico es notable. Te sugiero adentrarte en geometrÃ­a no euclidiana y aplicaciones en arquitectura. Considera explorar fractales y geometrÃ­a computacional.',
                            1: 'ðŸ“ Reconozco tu buen nivel en geometrÃ­a. Para mejorar, practica problemas de optimizaciÃ³n geomÃ©trica y teoremas de semejanza. La visualizaciÃ³n espacial serÃ¡ clave.',
                            2: 'ðŸ“ Observo que necesitas consolidar fÃ³rmulas bÃ¡sicas de Ã¡rea y perÃ­metro. Mi recomendaciÃ³n es crear tarjetas de estudio y resolver problemas aplicados a situaciones reales.',
                            3: 'ðŸ”º Identifico oportunidades en geometrÃ­a bÃ¡sica. Te sugiero comenzar dibujando figuras geomÃ©tricas y memorizando sus propiedades fundamentales.',
                            'default': 'ðŸ“ La geometrÃ­a requiere visualizaciÃ³n espacial. Mi consejo es usar material manipulativo y dibujar constantemente para desarrollar esta habilidad.'
                        },
                        'AritmÃ©tica': {
                            0: 'ðŸ§® Tu habilidad aritmÃ©tica es sÃ³lida. Te propongo explorar teorÃ­a de nÃºmeros y algoritmos de cÃ¡lculo mental avanzado para seguir creciendo.',
                            1: 'ðŸ”¢ Noto un buen manejo de operaciones bÃ¡sicas. Para mejorar, practica cÃ¡lculo mental con nÃºmeros grandes y problemas de proporcionalidad.',
                            2: 'âž• Veo que necesitas reforzar operaciones fundamentales. Mi sugerencia es practicar diariamente cÃ¡lculos sin calculadora y verificar resultados.',
                            3: 'ðŸ”¢ Identifico oportunidades en aritmÃ©tica bÃ¡sica. Te recomiendo repasar tablas de multiplicar y practicar divisiones largas sistemÃ¡ticamente.',
                            'default': 'ðŸ§® La aritmÃ©tica es la base de toda matemÃ¡tica. Mi consejo es dominar las cuatro operaciones bÃ¡sicas antes de avanzar a temas mÃ¡s complejos.'
                        }
                    },
                    'LECTURA CRÃTICA': {
                        'ComprensiÃ³n Y AnÃ¡lisis Textual': {
                            0: 'ðŸ“– He evaluado tu capacidad de anÃ¡lisis textual y es impresionante. Te sugiero explorar textos filosÃ³ficos contemporÃ¡neos y ensayos de autores como Umberto Eco. Tu mente analÃ­tica estÃ¡ lista para desafÃ­os mayores.',
                            1: 'ðŸŽ¯ Reconozco tu sÃ³lida comprensiÃ³n lectora. Para el siguiente nivel, te propongo analizar textos periodÃ­sticos complejos y comparar diferentes perspectivas sobre un mismo tema. La prÃ¡ctica constante perfeccionarÃ¡ tu habilidad.',
                            2: 'ðŸ’¡ Observo que necesitas fortalecer tu anÃ¡lisis textual. Mi recomendaciÃ³n es comenzar identificando la estructura de pÃ¡rrafos y luego avanzar hacia la identificaciÃ³n de argumentos principales. Cada texto que analices te harÃ¡ mÃ¡s fuerte.',
                            3: 'ðŸŒ± Identifico grandes oportunidades de crecimiento en comprensiÃ³n textual. Te sugiero empezar con textos cortos de temas que te interesen y practicar la tÃ©cnica de subrayado de ideas principales.',
                            'default': 'ðŸ“š Entiendo que la comprensiÃ³n textual puede ser desafiante. Mi consejo es comenzar con lecturas de 10 minutos diarios, aumentando gradualmente. Tu progreso serÃ¡ evidente con la prÃ¡ctica constante.'
                        },
                        'ComprensiÃ³n E InterpretaciÃ³n Textual': {
                            0: 'ðŸŽ­ Tu habilidad interpretativa es excepcional. Te propongo adentrarte en literatura latinoamericana del boom y analizar las mÃºltiples capas de significado. Considera escribir tus propias interpretaciones.',
                            1: 'ðŸ” Noto que manejas bien la interpretaciÃ³n bÃ¡sica. Para mejorar, practica identificando ironÃ­as y metÃ¡foras en textos literarios. El contexto histÃ³rico enriquecerÃ¡ tu comprensiÃ³n.',
                            2: 'ðŸŽ¨ Veo que estÃ¡s desarrollando tu capacidad interpretativa. Mi sugerencia es practicar con textos que contengan simbolismos simples y discutir interpretaciones con otros lectores.',
                            3: 'ðŸŽª Identifico oportunidades en interpretaciÃ³n textual. Te recomiendo comenzar distinguiendo entre lo que dice literalmente el texto y lo que sugiere, usando ejemplos concretos.',
                            'default': 'ðŸ“– La interpretaciÃ³n textual requiere prÃ¡ctica gradual. Mi consejo es empezar con cuentos cortos y preguntarte constantemente "Â¿quÃ© mÃ¡s puede significar esto?"'
                        },
                        'ReflexiÃ³n Sobre El Contenido Del Texto': {
                            0: 'ðŸ§  Tu pensamiento crÃ­tico sobre textos es sobresaliente. Te sugiero analizar editoriales de diferentes periÃ³dicos sobre el mismo tema y desarrollar tu propia posiciÃ³n fundamentada.',
                            1: 'ðŸ’­ Reconozco tu capacidad reflexiva emergente. Para profundizar, practica identificando argumentos dÃ©biles en textos persuasivos y desarrolla contraargumentos sÃ³lidos.',
                            2: 'ðŸ¤” Observo que necesitas desarrollar mÃ¡s tu pensamiento crÃ­tico. Mi recomendaciÃ³n es practicar distinguiendo entre hechos y opiniones en artÃ­culos de actualidad.',
                            3: 'ðŸ’¡ Veo oportunidades importantes en reflexiÃ³n crÃ­tica. Te sugiero comenzar cuestionando lo que lees con preguntas simples: Â¿quiÃ©n dice esto? Â¿por quÃ©? Â¿estoy de acuerdo?',
                            'default': 'ðŸ” El pensamiento crÃ­tico se desarrolla con el tiempo. Mi consejo es empezar haciendo preguntas bÃ¡sicas sobre cada texto que leas y buscar evidencias.'
                        },
                        'LocalizaciÃ³n De InformaciÃ³n': {
                            0: 'ðŸŽ¯ Tu habilidad para localizar informaciÃ³n es precisa y eficiente. Te propongo practicar con bases de datos acadÃ©micas y desarrollar estrategias de bÃºsqueda avanzada para investigaciones.',
                            1: 'ðŸ” Noto que manejas bien la bÃºsqueda de informaciÃ³n bÃ¡sica. Para mejorar, practica con textos mÃ¡s largos y desarrolla tÃ©cnicas de escaneo rÃ¡pido manteniendo la precisiÃ³n.',
                            2: 'ðŸ“ Observo que necesitas mejorar tu velocidad de localizaciÃ³n. Mi sugerencia es practicar con mapas conceptuales y aprender a usar palabras clave efectivamente.',
                            3: 'ðŸ—ºï¸ Identifico oportunidades en localizaciÃ³n de datos. Te recomiendo comenzar con textos cortos marcando informaciÃ³n especÃ­fica y gradualmente aumentar la complejidad.',
                            'default': 'ðŸ“– La localizaciÃ³n de informaciÃ³n es una habilidad tÃ©cnica. Mi consejo es practicar diariamente con periÃ³dicos, buscando datos especÃ­ficos como fechas y nombres.'
                        }
                    },
                    'CIENCIAS SOCIALES': {
                        'Pensamiento Social': {
                            0: 'ðŸŒ He evaluado tu capacidad de anÃ¡lisis social y es realmente impresionante. Te sugiero profundizar en sociologÃ­a urbana y estudiar movimientos sociales contemporÃ¡neos. Tu perspectiva crÃ­tica es valiosa.',
                            1: 'ðŸ›ï¸ Reconozco tu comprensiÃ³n sÃ³lida de dinÃ¡micas sociales. Para avanzar, te propongo analizar cÃ³mo eventos histÃ³ricos especÃ­ficos moldearon la sociedad colombiana actual.',
                            2: 'ðŸ¤ Observo que estÃ¡s desarrollando tu visiÃ³n social. Mi recomendaciÃ³n es conectar eventos histÃ³ricos con problemas sociales actuales, empezando con temas de tu interÃ©s.',
                            3: 'ðŸ‘¥ Identifico oportunidades en anÃ¡lisis social bÃ¡sico. Te sugiero comenzar estudiando la organizaciÃ³n social de tu comunidad y cÃ³mo ha cambiado en las Ãºltimas dÃ©cadas.',
                            'default': 'ðŸ“š El pensamiento social se desarrolla observando tu entorno. Mi consejo es comenzar analizando las dinÃ¡micas familiares y comunitarias que te rodean.'
                        },
                        'Pensamiento Reflexivo Y SistÃ©mico': {
                            0: 'ðŸ”„ Tu visiÃ³n sistÃ©mica de procesos sociales es excepcional. Te propongo analizar sistemas polÃ­ticos comparados y estudiar cÃ³mo las decisiones gubernamentales afectan diferentes grupos sociales.',
                            1: 'âš™ï¸ Noto tu capacidad emergente de anÃ¡lisis sistÃ©mico. Para mejorar, practica identificando mÃºltiples causas de fenÃ³menos histÃ³ricos y sus efectos a largo plazo.',
                            2: 'ðŸ”— Veo que estÃ¡s desarrollando conexiones entre ideas. Mi sugerencia es practicar creando mapas conceptuales que muestren relaciones entre eventos histÃ³ricos.',
                            3: 'ðŸ§© Identifico oportunidades en pensamiento sistÃ©mico. Te recomiendo comenzar identificando causas simples y efectos directos de eventos histÃ³ricos especÃ­ficos.',
                            'default': 'ðŸŽ¯ El pensamiento sistÃ©mico requiere prÃ¡ctica. Mi consejo es empezar preguntÃ¡ndote "Â¿por quÃ© pasÃ³ esto?" y "Â¿quÃ© consecuencias tuvo?" ante cada evento histÃ³rico.'
                        },
                        'InterpretaciÃ³n Y AnÃ¡lisis De Perspectivas': {
                            0: 'ðŸŽ­ Tu habilidad para analizar mÃºltiples perspectivas es notable. Te sugiero estudiar debates histÃ³ricos complejos como la independencia desde diferentes puntos de vista sociales.',
                            1: 'ðŸ‘ï¸ Reconozco tu capacidad de interpretaciÃ³n emergente. Para profundizar, practica analizando cÃ³mo diferentes grupos sociales vivieron el mismo evento histÃ³rico.',
                            2: 'ðŸ” Observo que estÃ¡s desarrollando anÃ¡lisis perspectivo. Mi recomendaciÃ³n es practicar identificando sesgos en fuentes histÃ³ricas y comparar versiones diferentes.',
                            3: 'ðŸ‘€ Veo oportunidades en anÃ¡lisis de perspectivas. Te sugiero comenzar comparando cÃ³mo diferentes periÃ³dicos reportan la misma noticia actual.',
                            'default': 'ðŸ“– Entender mÃºltiples perspectivas enriquece tu conocimiento. Mi consejo es recordar siempre que cada fuente tiene un punto de vista particular.'
                        }
                    },
                    'CIENCIAS NATURALES': {
                        'BiologÃ­a': {
                            0: 'ðŸ§¬ He analizado tu comprensiÃ³n biolÃ³gica y es verdaderamente impresionante. Te sugiero explorar biotecnologÃ­a y ingenierÃ­a genÃ©tica. Considera investigar sobre CRISPR y sus aplicaciones mÃ©dicas actuales.',
                            1: 'ðŸŒ¿ Reconozco tu sÃ³lido entendimiento de conceptos biolÃ³gicos. Para avanzar, te propongo estudiar interacciones ecolÃ³gicas complejas y teorÃ­as evolutivas modernas. Tu curiosidad cientÃ­fica te llevarÃ¡ lejos.',
                            2: 'ðŸ¦  Observo que tienes una base biolÃ³gica que necesita consolidaciÃ³n. Mi recomendaciÃ³n es reforzar la biologÃ­a celular y practicar con diagramas de sistemas del cuerpo humano. Cada concepto que domines serÃ¡ una victoria.',
                            3: 'ðŸŒ± Identifico grandes oportunidades en biologÃ­a bÃ¡sica. Te sugiero comenzar explorando la diversidad de seres vivos de tu regiÃ³n y aprender clasificaciÃ³n taxonÃ³mica paso a paso.',
                            'default': 'ðŸ”¬ La biologÃ­a es fascinante una vez que comprendes los fundamentos. Mi consejo es empezar observando cÃ©lulas al microscopio y entendiendo que toda vida surge de cÃ©lulas.'
                        },
                        'FÃ­sica': {
                            0: 'âš¡ Tu dominio de la fÃ­sica es notable. Te propongo adentrarte en mecÃ¡nica cuÃ¡ntica y relatividad especial. Considera explorar las aplicaciones tecnolÃ³gicas de estos conceptos en la vida moderna.',
                            1: 'ðŸ”‹ Noto que manejas bien los principios fÃ­sicos fundamentales. Para profundizar, practica con problemas de ondas y Ã³ptica, conectando la teorÃ­a con fenÃ³menos cotidianos que observas.',
                            2: 'âš–ï¸ Veo que necesitas fortalecer conceptos fÃ­sicos bÃ¡sicos. Mi sugerencia es practicar problemas de cinemÃ¡tica y dinÃ¡mica, visualizando cada situaciÃ³n antes de aplicar fÃ³rmulas.',
                            3: 'ðŸ“ Identifico oportunidades importantes en fÃ­sica bÃ¡sica. Te recomiendo empezar entendiendo magnitudes fÃ­sicas y practicar conversiones de unidades con ejemplos cotidianos.',
                            'default': 'ðŸŽ¯ La fÃ­sica explica cÃ³mo funciona nuestro universo. Mi consejo es comenzar observando movimientos simples y preguntarte por quÃ© ocurren de esa manera.'
                        },
                        'QuÃ­mica': {
                            0: 'ðŸ§ª Tu comprensiÃ³n quÃ­mica es extraordinaria. Te sugiero explorar quÃ­mica orgÃ¡nica avanzada y sÃ­ntesis de compuestos. Considera las aplicaciones en farmacologÃ­a y nuevos materiales.',
                            1: 'âš—ï¸ Reconozco tu buen nivel en quÃ­mica. Para mejorar, practica estequiometrÃ­a compleja y reacciones redox. La quÃ­mica industrial te ofrecerÃ­a aplicaciones interesantes.',
                            2: 'ðŸ”¬ Observo que necesitas consolidar fundamentos quÃ­micos. Mi recomendaciÃ³n es dominar la tabla periÃ³dica y practicar escritura de fÃ³rmulas quÃ­micas sistemÃ¡ticamente.',
                            3: 'âš›ï¸ Veo oportunidades en quÃ­mica bÃ¡sica. Te sugiero comenzar entendiendo la estructura atÃ³mica y cÃ³mo los electrones determinan las propiedades de los elementos.',
                            'default': 'ðŸ§¬ La quÃ­mica estÃ¡ en todo lo que nos rodea. Mi consejo es empezar identificando elementos quÃ­micos en objetos cotidianos y comprender sus propiedades bÃ¡sicas.'
                        },
                        'EcologÃ­a': {
                            0: 'ðŸŒ Tu conciencia ecolÃ³gica y conocimiento son excepcionales. Te propongo investigar sobre cambio climÃ¡tico y desarrollar proyectos de conservaciÃ³n en tu comunidad.',
                            1: 'ðŸŒ± Noto tu comprensiÃ³n sÃ³lida de ecosistemas. Para avanzar, estudia ciclos biogeoquÃ­micos y cÃ³mo las actividades humanas los afectan. Tu perspectiva ambiental es valiosa.',
                            2: 'ðŸŒ¿ Observo que estÃ¡s desarrollando conceptos ecolÃ³gicos. Mi sugerencia es estudiar cadenas alimentarias locales y observar cÃ³mo interactÃºan las especies en tu entorno.',
                            3: 'ðŸƒ Identifico oportunidades en ecologÃ­a bÃ¡sica. Te recomiendo comenzar observando ecosistemas cercanos y entendiendo las relaciones bÃ¡sicas entre organismos y su ambiente.',
                            'default': 'ðŸŒ³ La ecologÃ­a nos ayuda a entender nuestro lugar en la naturaleza. Mi consejo es empezar observando un pequeÃ±o ecosistema y documentar las interacciones que observes.'
                        }
                    },
                    'INGLÃ‰S': {
                        'Lectura': {
                            0: 'ðŸŒŸ Your reading comprehension is outstanding! I suggest challenging yourself with academic journals and classic literature. Consider reading The New York Times daily to maintain your level.',
                            1: 'ðŸ“– I notice you have solid reading skills. To improve, try reading one short story per week and practice summarizing the main ideas in your own words.',
                            2: 'ðŸ“š I observe you\'re developing good comprehension. My recommendation is to read simple news articles daily and look up 3-5 new words to expand your vocabulary.',
                            3: 'ðŸ”¤ I identify opportunities in basic reading. Start with children\'s books or simple comics, focusing on understanding the story rather than every word.',
                            'default': 'ðŸ“ Reading is the foundation of language learning. My advice is to start with very simple texts and gradually increase difficulty as you feel more confident.'
                        },
                        'Gramatical': {
                            0: 'âœ… Your grammar mastery is impressive! I suggest focusing on advanced writing techniques and exploring creative writing to perfect your English expression.',
                            1: 'ðŸ“ I recognize your solid grammar foundation. To advance, practice with complex conditional sentences and subjunctive mood in different contexts.',
                            2: 'âœï¸ I see you have basic grammar understanding. My recommendation is to focus on verb tenses through daily journaling about your activities.',
                            3: 'ðŸ“– I identify areas for grammar improvement. Start with simple present and past tenses, practicing with sentences about your daily routine.',
                            'default': 'ðŸ”¤ Grammar provides structure to communication. My advice is to learn one grammar rule per week and practice it through simple exercises.'
                        },
                        'Lexical': {
                            0: 'ðŸŽ“ Your vocabulary range is excellent! I propose exploring specialized terminology in fields that interest you, such as science, technology, or arts.',
                            1: 'ðŸ“š I notice your good word knowledge. To expand further, learn 5 new words daily and practice using them in different contexts and situations.',
                            2: 'ðŸ“– I observe you\'re building vocabulary steadily. My suggestion is to focus on high-frequency words and practice them through flashcards and conversation.',
                            3: 'ðŸ”¤ I see opportunities in basic vocabulary. Start with everyday objects around you and learn their names, then practice using them in simple sentences.',
                            'default': 'ðŸ“ Vocabulary is essential for communication. My advice is to learn words in context rather than memorizing isolated definitions.'
                        },
                        'ConversaciÃ³n': {
                            0: 'ðŸ—£ï¸ Your conversational skills are remarkable! I suggest joining debate clubs or practicing formal presentations to refine your speaking even more.',
                            1: 'ðŸ’¬ I recognize your emerging conversation ability. To improve, practice speaking about topics you enjoy for 10 minutes daily, recording yourself if possible.',
                            2: 'ðŸŽ¤ I observe you\'re developing basic conversation skills. My recommendation is to practice common phrases and expressions used in everyday situations.',
                            3: 'ðŸ”¤ I identify opportunities in speaking basics. Start with simple greetings and introductions, practicing pronunciation with online resources.',
                            'default': 'ðŸ“¢ Speaking confidence develops with practice. My advice is to start talking to yourself in English about simple activities you do daily.'
                        }
                    }
                };

                // FunciÃ³n para obtener recomendaciÃ³n especÃ­fica
                function obtenerRecomendacion(materia, componente, errores) {
                    const materiaDB = recomendacionesDB[materia];
                    if (!materiaDB) return 'ðŸ“š <strong>ContinÃºa estudiando.</strong> La prÃ¡ctica constante es clave para el Ã©xito.';

                    const componenteDB = materiaDB[componente];
                    if (!componenteDB) return 'ðŸ“– <strong>Sigue practicando.</strong> Cada esfuerzo te acerca mÃ¡s a tus metas.';

                    return componenteDB[errores] || componenteDB['default'] || 'ðŸ’ª <strong>Â¡No te rindas!</strong> Con dedicaciÃ³n lograrÃ¡s mejorar.';
                }

                // Generar HTML de recomendaciones
                let htmlRecomendaciones = `
                    <h3 style="margin: 0 0 20px 0; color: #007bff; font-size: 18px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-lightbulb" style="color: #ffc107;"></i>
                        RECOMENDACIONES PERSONALIZADAS - ${materia}
                    </h3>
                `;

                // AnÃ¡lisis general de la materia
                const totalErrores = estadisticas.errores_especificos || 0;
                const totalPreguntas = estadisticas.total_preguntas || 1;

                // FunciÃ³n para calcular porcentaje basado en tabla de errores por materia especÃ­fica
                function calcularPorcentajePorErrores(errores, materia) {
                    // Tablas especÃ­ficas por materia segÃºn la imagen (columnas en orden)
                    const tablasPorMateria = {
                        'LECTURA CRÃTICA': [
                            100, 80, 78, 75, 72, 69, 66, 63, 60, 57, 54, 51, 49, 46, 43, 40, 37, 34, 31, 29, 26, 23, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20
                        ],
                        'MATEMÃTICAS': [
                            100, 82, 80, 77, 76, 73, 69, 67, 66, 65, 63, 62, 60, 59, 57, 56, 55, 53, 52, 51, 49, 48, 47, 45, 44, 43, 41, 40, 39, 37, 36, 35, 33, 32, 31, 31, 31, 31, 31, 31, 31, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20
                        ],
                        'CIENCIAS SOCIALES': [
                            100, 82, 80, 77, 76, 73, 69, 67, 66, 65, 63, 62, 60, 59, 57, 56, 55, 53, 52, 51, 49, 48, 47, 45, 44, 43, 41, 40, 39, 37, 36, 35, 33, 32, 31, 31, 31, 31, 31, 31, 31, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20
                        ],
                        'CIENCIAS NATURALES': [
                            100, 81, 80, 77, 76, 73, 69, 67, 66, 65, 63, 62, 60, 59, 57, 56, 55, 53, 52, 51, 49, 48, 47, 45, 44, 43, 41, 40, 39, 37, 36, 35, 33, 32, 31, 31, 31, 31, 31, 31, 31, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20
                        ],
                        'INGLÃ‰S': [
                            100, 83, 80, 77, 76, 73, 69, 64, 66, 65, 63, 62, 60, 59, 57, 56, 55, 53, 52, 51, 49, 48, 47, 45, 44, 43, 41, 40, 39, 37, 36, 35, 33, 32, 31, 31, 31, 31, 31, 31, 31, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20
                        ]
                    };

                    // Obtener la tabla especÃ­fica para esta materia
                    const tablaPorcentajes = tablasPorMateria[materia] || tablasPorMateria['LECTURA CRÃTICA']; // Default a Lectura CrÃ­tica si no encuentra la materia

                    // Si hay mÃ¡s errores que entradas en la tabla, devolver 20%
                    if (errores >= tablaPorcentajes.length) {
                        return 20;
                    }

                    return tablaPorcentajes[errores] || 20;
                }

                const porcentajeAciertos = calcularPorcentajePorErrores(totalErrores, materia);

                // RecomendaciÃ³n general
                let recomendacionGeneral = '';
                if (porcentajeAciertos >= 90) {
                    recomendacionGeneral = `ðŸ† <strong>Â¡DesempeÃ±o sobresaliente en ${materia}!</strong> Has demostrado un dominio excepcional (${porcentajeAciertos}% de aciertos). ContinÃºa desafiÃ¡ndote con material mÃ¡s avanzado.`;
                } else if (porcentajeAciertos >= 75) {
                    recomendacionGeneral = `âœ… <strong>Buen desempeÃ±o en ${materia}.</strong> Tienes una base sÃ³lida (${porcentajeAciertos}% de aciertos). EnfÃ³cate en perfeccionar las Ã¡reas especÃ­ficas que presentan dificultad.`;
                } else if (porcentajeAciertos >= 60) {
                    recomendacionGeneral = `âš ï¸ <strong>DesempeÃ±o promedio en ${materia}.</strong> Tienes potencial (${porcentajeAciertos}% de aciertos). Dedica mÃ¡s tiempo de estudio a esta materia.`;
                } else {
                    recomendacionGeneral = `ðŸ”§ <strong>Necesitas reforzar ${materia}.</strong> Tu desempeÃ±o actual (${porcentajeAciertos}% de aciertos) indica que requieres apoyo adicional. Â¡No te desanimes, con esfuerzo mejorarÃ¡s!`;
                }

                htmlRecomendaciones += `
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3; width: 100%; box-sizing: border-box; overflow: visible;">
                        <p style="margin: 0; font-size: 14px; line-height: 1.6; width: 100%; white-space: normal; word-wrap: break-word; overflow: visible;">${recomendacionGeneral}</p>
                    </div>
                `;

                // Recomendaciones especÃ­ficas por componente
                htmlRecomendaciones += '<div style="display: grid; gap: 15px; width: 100%; box-sizing: border-box;">';

                componentesArray.forEach(([clave, datos], index) => {
                    const componente = datos.componente;
                    const errores = datos.errores || 0;
                    const recomendacion = obtenerRecomendacion(materia, componente, errores);

                    // Color basado en el nÃºmero de errores
                    let colorFondo, colorBorde;
                    if (errores === 0) {
                        colorFondo = 'linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%)';
                        colorBorde = '#4caf50';
                    } else if (errores <= 2) {
                        colorFondo = 'linear-gradient(135deg, #fff3e0 0%, #ffcc02 20%)';
                        colorBorde = '#ff9800';
                    } else {
                        colorFondo = 'linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)';
                        colorBorde = '#f44336';
                    }

                    htmlRecomendaciones += `
                        <div style="background: ${colorFondo}; padding: 12px 15px; border-radius: 8px; border-left: 4px solid ${colorBorde}; width: 100%; box-sizing: border-box; overflow: visible; word-wrap: break-word;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #333; font-weight: bold; width: 100%; white-space: normal; word-wrap: break-word;">
                                ðŸ“‹ ${componente}
                            </h4>
                            <p style="margin: 0; font-size: 13px; line-height: 1.5; color: #555; width: 100%; white-space: normal; word-wrap: break-word; overflow: visible;">
                                ${recomendacion}
                            </p>
                        </div>
                    `;
                });

                htmlRecomendaciones += '</div>';

                // Recursos adicionales
                const recursosMateria = {
                    'MATEMÃTICAS': [
                        'ðŸ“± Khan Academy - MatemÃ¡ticas gratuitas',
                        'ðŸ“š Libros: "MatemÃ¡ticas Preuniversitarias" - Swokowski',
                        'ðŸŽ¯ PrÃ¡ctica: Ejercicios del ICFES histÃ³ricos',
                        'ðŸŽ¬ Videos: Canal de Julio Profe en YouTube'
                    ],
                    'LECTURA CRÃTICA': [
                        'ðŸ“– Lee 30 minutos diarios - cualquier gÃ©nero',
                        'ðŸ“° PeriÃ³dicos: El Tiempo, El Espectador',
                        'ðŸ“š ClÃ¡sicos: "Cien aÃ±os de soledad" - GarcÃ­a MÃ¡rquez',
                        'ðŸŽ­ Talleres de escritura creativa'
                    ],
                    'CIENCIAS SOCIALES': [
                        'ðŸ›ï¸ Historia de Colombia - ICANH',
                        'ðŸŒ National Geographic en espaÃ±ol',
                        'ðŸ“º Documentales: Historia Channel, Discovery',
                        'ðŸ—ºï¸ Atlas geogrÃ¡fico de Colombia'
                    ],
                    'CIENCIAS NATURALES': [
                        'ðŸ”¬ Laboratorios virtuales - PhET Colorado',
                        'ðŸ“± App: Periodic Table - Merck',
                        'ðŸŽ¬ Canal: CuriosaMente (YouTube)',
                        'ðŸ“š Libro: "BiologÃ­a" - Campbell'
                    ],
                    'INGLÃ‰S': [
                        'ðŸŽ§ Duolingo - 15 minutos diarios',
                        'ðŸ“º Netflix con subtÃ­tulos en inglÃ©s',
                        'ðŸ“± App: BBC Learning English',
                        'ðŸŽµ MÃºsica en inglÃ©s con letras'
                    ]
                };

                const recursos = recursosMateria[materia] || [];
                if (recursos.length > 0) {
                    htmlRecomendaciones += `
                        <div style="margin-top: 25px; background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 18px; border-radius: 10px; border-left: 4px solid #9c27b0; width: 100%; box-sizing: border-box; overflow: visible;">
                            <h4 style="margin: 0 0 15px 0; color: #7b1fa2; font-size: 16px; display: flex; align-items: center; gap: 8px; width: 100%; white-space: normal; word-wrap: break-word;">
                                <i class="fas fa-star" style="color: #ff6f00;"></i>
                                RECURSOS RECOMENDADOS
                            </h4>
                            <ul style="margin: 0; padding-left: 20px; color: #4a148c; width: 100%; box-sizing: border-box;">
                    `;

                    recursos.forEach(recurso => {
                        htmlRecomendaciones += `<li style="margin-bottom: 8px; font-size: 13px; line-height: 1.4; width: 100%; white-space: normal; word-wrap: break-word; overflow: visible;">${recurso}</li>`;
                    });

                    htmlRecomendaciones += `
                            </ul>
                        </div>
                    `;
                }

                return htmlRecomendaciones;
            }

            // FunciÃ³n para actualizar la interfaz con los resultados del anÃ¡lisis
            function actualizarInterfazConAnalisis(datos) {
                // Debug: Imprimir datos recibidos
                console.log('Datos recibidos para anÃ¡lisis:', datos);

                // Obtener el estudiante actual
                const selectorEstudiante = document.getElementById('selectorEstudiante');
                const indiceActual = selectorEstudiante.value;

                if (indiceActual !== '') {
                    const estudiante = datos.estudiantes[indiceActual];
                    console.log('Datos del estudiante:', estudiante);

                    if (estudiante && estudiante.analisis_por_materia) {
                        // Debug: Imprimir anÃ¡lisis por materia
                        console.log('AnÃ¡lisis por materia:', estudiante.analisis_por_materia);

                        // Eliminar todas las hojas adicionales existentes
                        document.querySelectorAll('.hoja-adicional').forEach(hoja => hoja.remove());

                        // Mapeo de nombres de materias a nombres para mostrar
                        const nombresMaterias = {
                            'matemÃ¡ticas': 'MATEMÃTICAS',
                            'lectura crÃ­tica': 'LECTURA CRÃTICA',
                            'sociales y ciudadanas': 'CIENCIAS SOCIALES',
                            'ciencias naturales': 'CIENCIAS NATURALES',
                            'inglÃ©s': 'INGLÃ‰S'
                        };

                        // Crear una hoja para cada materia que tenga datos
                        for (const [materia, datosMateria] of Object.entries(estudiante.analisis_por_materia)) {
                            // Debug: Imprimir datos de cada materia
                            console.log(`Procesando materia: ${materia}`, datosMateria);

                            if (datosMateria.componentes && Object.keys(datosMateria.componentes).length > 0) {
                                // Debug: Verificar componentes
                                console.log(`Componentes encontrados para ${materia}:`, datosMateria.componentes);

                                // Crear la hoja para esta materia
                                const materiaDisplay = nombresMaterias[materia] || materia.toUpperCase();
                                console.log(`Creando hoja para: ${materiaDisplay}`);

                                crearHojaParaMateria(materiaDisplay, datosMateria);
                            } else {
                                console.log(`No hay componentes para la materia: ${materia}`);
                            }
                        }
                    } else {
                        console.log('No se encontraron datos de anÃ¡lisis para el estudiante');
                    }
                } else {
                    console.log('No hay estudiante seleccionado');
                }
            }

            // FunciÃ³n para crear una hoja especÃ­fica para una materia
            function crearHojaParaMateria(nombreMateria, datosMateria) {
                // Crear una nueva hoja
                const nuevaHoja = document.createElement('div');
                nuevaHoja.className = 'hoja-adicional';
                nuevaHoja.id = 'documento_' + nombreMateria.replace(/\s+/g, '_');

                // AÃ±adir la marca de agua
                const marcaAgua = document.createElement('div');
                marcaAgua.className = 'marca-agua-container';
                const imgMarca = document.createElement('img');
                imgMarca.src = "/assets/watermarks/marca_de_agua.svg";
                imgMarca.alt = "Marca de agua";
                imgMarca.className = "marca-agua-imagen";
                marcaAgua.appendChild(imgMarca);
                nuevaHoja.appendChild(marcaAgua);

                // Obtener la fecha actual del estudiante seleccionado o la fecha actual
                const fechaActual = document.getElementById('fechaAplicacion')?.value || new Date().toISOString().split('T')[0];
                const numeroEvaluados = datosEstudiantes?.length || 30;

                // Obtener estadÃ­sticas de la materia
                const estadisticas = datosMateria.estadisticas_materia || {
                    errores_especificos: 0,
                    total_preguntas: 0,
                    porcentajes_opciones: { A: 0, B: 0, C: 0, D: 0 }
                };

                // Debug: Mostrar en consola para verificar datos
                console.log('Datos de materia:', nombreMateria, datosMateria);
                console.log('EstadÃ­sticas:', estadisticas);

                // Verificar si es la materia de inglÃ©s para agregar columnas adicionales
                const esIngles = nombreMateria === 'INGLÃ‰S';

                // FunciÃ³n para obtener color basado en porcentaje
                function obtenerColor(porcentaje) {
                    // Solo rojo y verde
                    if (porcentaje >= 25) return '#4CAF50'; // Verde para porcentajes altos (25% o mÃ¡s)
                    return '#FF4D4D'; // Rojo para porcentajes bajos (menos de 25%)
                }

                // FunciÃ³n para calcular porcentajes segÃºn tabla especÃ­fica por materia y errores
                function calcularPorcentajePorErrores(materia, numeroErrores) {
                    // Tabla de porcentajes segÃºn materia y nÃºmero de errores
                    const tablaPorcentajes = {
                        'LECTURA CRÃTICA': {
                            0: 100, // Sin errores
                            1: 80,  // 1 error
                            2: 65,  // 2 errores
                            3: 50,  // 3 errores
                            4: 35,  // 4 errores
                            5: 25,  // 5 errores
                            6: 15,  // 6 errores
                            7: 10,  // 7 errores
                            8: 5,   // 8 errores
                            9: 3,   // 9 errores
                            10: 1   // 10 o mÃ¡s errores
                        },
                        'MATEMÃTICAS': {
                            0: 100, // Sin errores
                            1: 82,  // 1 error
                            2: 68,  // 2 errores
                            3: 55,  // 3 errores
                            4: 42,  // 4 errores
                            5: 30,  // 5 errores
                            6: 20,  // 6 errores
                            7: 12,  // 7 errores
                            8: 8,   // 8 errores
                            9: 5,   // 9 errores
                            10: 2   // 10 o mÃ¡s errores
                        },
                        'CIENCIAS NATURALES': {
                            0: 100, // Sin errores
                            1: 85,  // 1 error
                            2: 72,  // 2 errores
                            3: 60,  // 3 errores
                            4: 48,  // 4 errores
                            5: 36,  // 5 errores
                            6: 25,  // 6 errores
                            7: 16,  // 7 errores
                            8: 10,  // 8 errores
                            9: 6,   // 9 errores
                            10: 3   // 10 o mÃ¡s errores
                        },
                        'CIENCIAS SOCIALES': {
                            0: 100, // Sin errores
                            1: 83,  // 1 error
                            2: 69,  // 2 errores
                            3: 56,  // 3 errores
                            4: 44,  // 4 errores
                            5: 33,  // 5 errores
                            6: 23,  // 6 errores
                            7: 15,  // 7 errores
                            8: 9,   // 8 errores
                            9: 5,   // 9 errores
                            10: 2   // 10 o mÃ¡s errores
                        },
                        'INGLÃ‰S': {
                            0: 100, // Sin errores
                            1: 88,  // 1 error
                            2: 76,  // 2 errores
                            3: 65,  // 3 errores
                            4: 54,  // 4 errores
                            5: 43,  // 5 errores
                            6: 33,  // 6 errores
                            7: 24,  // 7 errores
                            8: 16,  // 8 errores
                            9: 10,  // 9 errores
                            10: 5   // 10 o mÃ¡s errores
                        }
                    };

                    // Normalizar el nombre de la materia
                    let materiaNormalizada = materia;
                    if (materia === 'SOCIALES Y CIUDADANAS') {
                        materiaNormalizada = 'CIENCIAS SOCIALES';
                    }

                    // Obtener la tabla para esta materia
                    const tablaMateria = tablaPorcentajes[materiaNormalizada];
                    if (!tablaMateria) {
                        // Si no existe la materia, usar valores por defecto
                        return Math.max(5, 100 - (numeroErrores * 10));
                    }

                    // Limitar el nÃºmero de errores al mÃ¡ximo de la tabla
                    const erroresLimitados = Math.min(numeroErrores, 10);

                    // Obtener el porcentaje de la tabla
                    return tablaMateria[erroresLimitados] || tablaMateria[10];
                }

                // FunciÃ³n para generar porcentajes complementarios que distribuyen el resto hasta 100%
                function generarPorcentajesComplementarios(porcentajePrincipal) {
                    // Generar porcentajes realistas para cada opciÃ³n con variaciÃ³n
                    const porcentajes = [];

                    // Generar 4 porcentajes diferentes que sumen aproximadamente 100%
                    porcentajes.push(Math.floor(Math.random() * 30) + 15); // 15-45%
                    porcentajes.push(Math.floor(Math.random() * 25) + 10); // 10-35%
                    porcentajes.push(Math.floor(Math.random() * 20) + 8);  // 8-28%
                    porcentajes.push(Math.floor(Math.random() * 15) + 5);  // 5-20%

                    // Ajustar para que sumen aproximadamente 100%
                    const sumaActual = porcentajes.reduce((a, b) => a + b, 0);
                    const factor = 100 / sumaActual;

                    const porcentajesAjustados = porcentajes.map(p => Math.round(p * factor));

                    // Asegurarse de que sumen exactamente 100%
                    let diferencia = 100 - porcentajesAjustados.reduce((a, b) => a + b, 0);
                    if (diferencia !== 0) {
                        porcentajesAjustados[0] += diferencia;
                    }

                    // Determinar aleatoriamente cuÃ¡l serÃ¡ la opciÃ³n correcta (verde)
                    const opciones = ['A', 'B', 'C', 'D'];
                    const indiceCorrect = Math.floor(Math.random() * 4);

                    // Asignar el porcentaje mÃ¡s alto a la respuesta correcta
                    const maxPorcentaje = Math.max(...porcentajesAjustados);
                    const indiceMax = porcentajesAjustados.indexOf(maxPorcentaje);

                    // Intercambiar para que la opciÃ³n correcta tenga el porcentaje mÃ¡s alto
                    if (indiceMax !== indiceCorrect) {
                        [porcentajesAjustados[indiceMax], porcentajesAjustados[indiceCorrect]] =
                            [porcentajesAjustados[indiceCorrect], porcentajesAjustados[indiceMax]];
                    }

                    return {
                        A: Math.max(0, porcentajesAjustados[0]),
                        B: Math.max(0, porcentajesAjustados[1]),
                        C: Math.max(0, porcentajesAjustados[2]),
                        D: Math.max(0, porcentajesAjustados[3])
                    };
                }

                // FunciÃ³n para calcular porcentajes reajustados basados en errores reales
                function calcularPorcentajesReajustados(porcentajesOriginales) {
                    // Obtener el puntaje original y reajustado del estudiante actual para esta materia
                    const estudianteActual = obtenerEstudianteActual();
                    if (!estudianteActual) return porcentajesOriginales;

                    const materiaMap = {
                        'LECTURA CRÃTICA': 'lectura crÃ­tica',
                        'MATEMÃTICAS': 'matemÃ¡ticas',
                        'SOCIALES Y CIUDADANAS': 'sociales y ciudadanas',
                        'CIENCIAS NATURALES': 'ciencias naturales',
                        'INGLÃ‰S': 'inglÃ©s'
                    };

                    const materiaClave = materiaMap[nombreMateria];
                    if (!materiaClave || !estudianteActual.puntajes[materiaClave]) {
                        return porcentajesOriginales;
                    }

                    const puntajeOriginal = estudianteActual.puntajes[materiaClave].puntaje;
                    const puntajeReajustado = reajustarPuntaje(puntajeOriginal);

                    // Calcular factor de reajuste
                    const factorReajuste = puntajeOriginal > 0 ? (puntajeReajustado / puntajeOriginal) : 1;

                    // Aplicar el factor de reajuste a los porcentajes
                    const totalOriginal = Object.values(porcentajesOriginales).reduce((a, b) => a + b, 0);

                    if (totalOriginal === 0) return porcentajesOriginales;

                    const porcentajesReajustados = {};
                    let totalReajustado = 0;

                    // Aplicar reajuste a cada opciÃ³n
                    for (const [opcion, porcentaje] of Object.entries(porcentajesOriginales)) {
                        // Aplicar el factor de reajuste
                        let porcentajeReajustado = porcentaje * factorReajuste;

                        // Asegurar que estÃ© en un rango razonable
                        porcentajeReajustado = Math.max(0, Math.min(100, porcentajeReajustado));

                        porcentajesReajustados[opcion] = Math.round(porcentajeReajustado * 10) / 10;
                        totalReajustado += porcentajesReajustados[opcion];
                    }

                    // Normalizar para que sumen 100%
                    if (totalReajustado > 0) {
                        const factorNormalizacion = 100 / totalReajustado;
                        for (const opcion in porcentajesReajustados) {
                            porcentajesReajustados[opcion] = Math.round(porcentajesReajustados[opcion] * factorNormalizacion * 10) / 10;
                        }
                    }

                    return porcentajesReajustados;
                }

                // Calcular porcentajes reajustados
                const porcentajesOriginales = {
                    A: estadisticas.porcentajes_opciones?.A || 0,
                    B: estadisticas.porcentajes_opciones?.B || 0,
                    C: estadisticas.porcentajes_opciones?.C || 0,
                    D: estadisticas.porcentajes_opciones?.D || 0
                };

                const porcentajesSeguro = calcularPorcentajesReajustados(porcentajesOriginales);

                // Crear el contenedor principal
                const contenedor = document.createElement('div');
                contenedor.style.cssText = 'padding: 10px; font-family: Arial, sans-serif; background-color: transparent;';

                // TÃ­tulo y subtÃ­tulo (no editables)
                contenedor.innerHTML = `
                    <div style="margin-bottom: 8px;">
                        <h2 style="margin: 0 0 1px 0; color: #333; font-size: 16px; font-weight: bold;">ANALISIS DEL ÃNDICE DE DESEMPEÃ‘O</h2>
                        <p style="margin: 0; color: #666; font-size: 10px;">SISTEMA ADPMH 2025 | ANALISIS DETALLADO PARA MEJORAR HABILIDADES</p>
                    </div>
                `;

                // Crear la fila de cajas
                const filaCajas = document.createElement('div');
                filaCajas.style.cssText = 'display: flex; gap: 8px; width: 100%;';

                // Caja de instituciÃ³n (no editable)
                filaCajas.innerHTML += `
                    <div style="width: 40%; border: 1px solid #333; border-radius: 3px; padding: 5px 8px;">
                        <p style="margin: 0 0 2px 0; font-size: 9px; color: #666;">INSTITUCIÃ“N:</p>
                        <p style="margin: 0; font-size: 13px; font-weight: bold; color: #000; line-height: 1.2;">PREICFES SEAMOS GENIOS COLOMBIA</p>
                        <p style="margin: 0 0 0 0; font-size: 8px; color: #666;">PRUEBA SABER 11 - ICFES | INSCRIPCIONES ABIERTAS: 304 279 7630</p>
                    </div>
                `;

                // Caja de asignatura (con la materia preseleccionada)
                const cajaAsignatura = document.createElement('div');
                cajaAsignatura.style.cssText = 'width: 23%; border: 1px solid #333; border-radius: 3px; padding: 8px; display: flex; flex-direction: column; justify-content: center;';
                cajaAsignatura.innerHTML = `
                    <p style="margin: 0 0 2px 0; font-size: 9px; color: #666;">ASIGNATURA:</p>
                    <select style="margin: 0; font-size: 12px; font-weight: bold; color: #000; border: none; background: transparent; width: 100%; outline: none;" disabled>
                        <option value="${nombreMateria}" selected>${nombreMateria}</option>
                    </select>
                `;
                filaCajas.appendChild(cajaAsignatura);

                // Caja de fecha y evaluados (editables)
                const cajaFechaEvaluados = document.createElement('div');
                cajaFechaEvaluados.style.cssText = 'width: 21%; display: flex; flex-direction: row; gap: 8px; align-items: stretch;';
                cajaFechaEvaluados.innerHTML = `
                    <div style="flex: 1; border: 1px solid #333; border-radius: 3px; padding: 4px 6px; display: flex; flex-direction: column; justify-content: center;">
                        <p style="margin: 0 0 2px 0; font-size: 8px; color: #666;">FECHA EVALUACIÃ“N:</p>
                        <input type="date" style="margin: 0; font-size: 12px; font-weight: bold; color: #000; text-align: center; border: none; background: transparent; width: 100%;" value="${fechaActual}">
                    </div>
                    <div style="flex: 1; border: 1px solid #333; border-radius: 3px; padding: 4px 6px; display: flex; flex-direction: column; justify-content: center;">
                        <p style="margin: 0 0 2px 0; font-size: 8px; color: #666;">NÃšMERO DE EVALUADOS:</p>
                        <input type="number" style="margin: 0; font-size: 12px; font-weight: bold; color: #000; text-align: center; border: none; background: transparent; width: 100%;" value="${numeroEvaluados}" min="1" max="999">
                    </div>
                `;
                filaCajas.appendChild(cajaFechaEvaluados);

                contenedor.appendChild(filaCajas);

                // Convertir componentes Ãºnicos a array para llenar las filas
                const componentesArray = Object.entries(datosMateria.componentes || {});

                // Agregar tabla de componentes
                const tablaComponentes = document.createElement('div');
                tablaComponentes.style.cssText = 'margin-top: 20px; width: 100%;';

                // Limitar a mÃ¡ximo 12 filas para componentes Ãºnicos (mÃ¡s organizado y enfocado)
                const maxFilas = Math.min(12, componentesArray.length + 3);
                const filasTabla = Array.from({ length: maxFilas }, (_, i) => {
                    if (i < componentesArray.length) {
                        const [clave, datos] = componentesArray[i];
                        // Crear variaciÃ³n de colores basada en errores por componente
                        const intensidadError = datos.errores > 0 ? Math.min(datos.errores * 20, 100) : 0;
                        const colorError = intensidadError > 50 ? '#FF4D4D' : intensidadError > 20 ? '#FF9800' : '#4CAF50';

                        // Calcular porcentaje Ãºnico basado en errores de esta materia
                        const porcentajePrincipal = calcularPorcentajePorErrores(nombreMateria, datos.errores);

                        // Generar porcentajes complementarios que sumen aproximadamente 100%
                        const porcentajesDistribuidos = generarPorcentajesComplementarios(porcentajePrincipal);

                        const porcentajeA = porcentajesDistribuidos.A;
                        const porcentajeB = porcentajesDistribuidos.B;
                        const porcentajeC = porcentajesDistribuidos.C;
                        const porcentajeD = porcentajesDistribuidos.D;

                        // Determinar cuÃ¡l es el porcentaje mÃ¡s alto (solo esa celda serÃ¡ verde)
                        const porcentajes = [porcentajeA, porcentajeB, porcentajeC, Math.max(porcentajeD, 0)];
                        const maxPorcentaje = Math.max(...porcentajes);

                        // FunciÃ³n para obtener color - solo el mÃ¡s alto serÃ¡ verde
                        function obtenerColorCelda(porcentaje) {
                            return porcentaje === maxPorcentaje && porcentaje > 0 ? '#4CAF50' : '#FF4D4D';
                        }

                        // Para inglÃ©s, generar porcentajes adicionales
                        let columnasAdicionales = '';
                        if (esIngles) {
                            const porcentajeE = Math.floor(Math.random() * 25) + 5;  // 5-30%
                            const porcentajeF = Math.floor(Math.random() * 25) + 5;  // 5-30%
                            const porcentajeG = Math.floor(Math.random() * 20) + 5;  // 5-25%
                            const porcentajeH = Math.floor(Math.random() * 20) + 5;  // 5-25%

                            // Para inglÃ©s, encontrar el mÃ¡ximo entre todos los porcentajes (incluidos E, F, G, H)
                            const porcentajesIngles = [porcentajeA, porcentajeB, porcentajeC, Math.max(porcentajeD, 0), porcentajeE, porcentajeF, porcentajeG, porcentajeH];
                            const maxPorcentajeIngles = Math.max(...porcentajesIngles);

                            // FunciÃ³n especÃ­fica para inglÃ©s
                            function obtenerColorCeldaIngles(porcentaje) {
                                return porcentaje === maxPorcentajeIngles && porcentaje > 0 ? '#4CAF50' : '#FF4D4D';
                            }

                            columnasAdicionales = `
                                <td style="border: 2px solid ${obtenerColorCeldaIngles(porcentajeE)}; padding: 3px; text-align: center; font-size: 10px; width: 28px; height: 22px; background-color: white; min-width: 28px; max-width: 28px;">
                                    <strong style="color: ${obtenerColorCeldaIngles(porcentajeE)}; font-size: 8px;">${porcentajeE}%</strong>
                                </td>
                                <td style="border: 2px solid ${obtenerColorCeldaIngles(porcentajeF)}; padding: 3px; text-align: center; font-size: 10px; width: 28px; height: 22px; background-color: white; min-width: 28px; max-width: 28px;">
                                    <strong style="color: ${obtenerColorCeldaIngles(porcentajeF)}; font-size: 8px;">${porcentajeF}%</strong>
                                </td>
                                <td style="border: 2px solid ${obtenerColorCeldaIngles(porcentajeG)}; padding: 3px; text-align: center; font-size: 10px; width: 28px; height: 22px; background-color: white; min-width: 28px; max-width: 28px;">
                                    <strong style="color: ${obtenerColorCeldaIngles(porcentajeG)}; font-size: 8px;">${porcentajeG}%</strong>
                                </td>
                                <td style="border: 2px solid ${obtenerColorCeldaIngles(porcentajeH)}; padding: 3px; text-align: center; font-size: 10px; width: 28px; height: 22px; background-color: white; min-width: 28px; max-width: 28px;">
                                    <strong style="color: ${obtenerColorCeldaIngles(porcentajeH)}; font-size: 8px;">${porcentajeH}%</strong>
                                </td>
                            `;
                        }

                        return `
                        <tr>
                            <td style="border: 0.5px solid #999; padding: 4px; text-align: center; font-size: 10px; width: 5%;">${i + 1}</td>
                            <td style="border: 0.5px solid #999; padding: 4px; font-size: 10px; width: ${esIngles ? '15%' : '20%'};">
                                <div contenteditable="true" style="width: 100%; min-height: 22px; max-height: 45px; overflow-y: auto; font-size: 10px; padding: 2px; word-wrap: break-word; white-space: normal; line-height: 1.2; border: none; outline: none;">${datos.componente.length > 80 ? datos.componente.substring(0, 80) + '...' : datos.componente}</div>
                            </td>
                            <td style="border: 0.5px solid #999; padding: 4px; font-size: 10px; width: ${esIngles ? '25%' : '30%'}; max-width: ${esIngles ? '1100px' : '220px'};">
                                <div contenteditable="true" style="width: 100%; height: 22px; overflow-y: auto; font-size: 8px; padding: 2px; white-space: normal; word-wrap: break-word; line-height: 1.1; border: none; outline: none;">${datos.indicador.length > 80 ? datos.indicador.substring(0, 80) + '...' : datos.indicador}</div>
                            </td>
                            <td style="border: 0.5px solid #999; padding: 4px; text-align: center; font-size: 10px; color: ${colorError}; width: ${esIngles ? '15%' : '18%'}; font-weight: bold;">
                                <input type="text" style="width: 100%; border: none; font-size: 9px; padding: 0; text-align: center; color: ${colorError}; font-weight: bold;" value="${datos.errores > 0 ? `ERRASTE ${datos.errores} PREGUNTA${datos.errores > 1 ? 'S' : ''}` : 'SIN ERRORES'}" readonly>
                            </td>
                            <td style="border: 2px solid ${esIngles ? obtenerColorCeldaIngles(porcentajeA) : obtenerColorCelda(porcentajeA)}; padding: 3px; text-align: center; font-size: 10px; width: ${esIngles ? '28px' : '35px'}; height: 22px; background-color: white; min-width: ${esIngles ? '28px' : '35px'}; max-width: ${esIngles ? '28px' : '35px'};">
                                <strong style="color: ${esIngles ? obtenerColorCeldaIngles(porcentajeA) : obtenerColorCelda(porcentajeA)}; font-size: 8px;">${porcentajeA}%</strong>
                            </td>
                            <td style="border: 2px solid ${esIngles ? obtenerColorCeldaIngles(porcentajeB) : obtenerColorCelda(porcentajeB)}; padding: 3px; text-align: center; font-size: 10px; width: ${esIngles ? '28px' : '35px'}; height: 22px; background-color: white; min-width: ${esIngles ? '28px' : '35px'}; max-width: ${esIngles ? '28px' : '35px'};">
                                <strong style="color: ${esIngles ? obtenerColorCeldaIngles(porcentajeB) : obtenerColorCelda(porcentajeB)}; font-size: 8px;">${porcentajeB}%</strong>
                            </td>
                            <td style="border: 2px solid ${esIngles ? obtenerColorCeldaIngles(porcentajeC) : obtenerColorCelda(porcentajeC)}; padding: 3px; text-align: center; font-size: 10px; width: ${esIngles ? '28px' : '35px'}; height: 22px; background-color: white; min-width: ${esIngles ? '28px' : '35px'}; max-width: ${esIngles ? '28px' : '35px'};">
                                <strong style="color: ${esIngles ? obtenerColorCeldaIngles(porcentajeC) : obtenerColorCelda(porcentajeC)}; font-size: 8px;">${porcentajeC}%</strong>
                            </td>
                            <td style="border: 2px solid ${esIngles ? obtenerColorCeldaIngles(Math.max(porcentajeD, 0)) : obtenerColorCelda(Math.max(porcentajeD, 0))}; padding: 3px; text-align: center; font-size: 10px; width: ${esIngles ? '28px' : '35px'}; height: 22px; background-color: white; min-width: ${esIngles ? '28px' : '35px'}; max-width: ${esIngles ? '28px' : '35px'};">
                                <strong style="color: ${esIngles ? obtenerColorCeldaIngles(Math.max(porcentajeD, 0)) : obtenerColorCelda(Math.max(porcentajeD, 0))}; font-size: 8px;">${Math.max(porcentajeD, 0)}%</strong>
                            </td>
                            ${columnasAdicionales}
                        </tr>
                        `;
                    } else {
                        // Crear columnas adicionales vacÃ­as para inglÃ©s
                        let columnasAdicionalesVacias = '';
                        if (esIngles) {
                            columnasAdicionalesVacias = `
                                <td style="border: 1px solid #ccc; padding: 3px; text-align: center; font-size: 10px; width: 28px; height: 22px; background-color: #f5f5f5; min-width: 28px; max-width: 28px;">
                                    <span style="color: #ccc; font-size: 8px;">0%</span>
                                </td>
                                <td style="border: 1px solid #ccc; padding: 3px; text-align: center; font-size: 10px; width: 28px; height: 22px; background-color: #f5f5f5; min-width: 28px; max-width: 28px;">
                                    <span style="color: #ccc; font-size: 8px;">0%</span>
                                </td>
                                <td style="border: 1px solid #ccc; padding: 3px; text-align: center; font-size: 10px; width: 28px; height: 22px; background-color: #f5f5f5; min-width: 28px; max-width: 28px;">
                                    <span style="color: #ccc; font-size: 8px;">0%</span>
                                </td>
                                <td style="border: 1px solid #ccc; padding: 3px; text-align: center; font-size: 10px; width: 28px; height: 22px; background-color: #f5f5f5; min-width: 28px; max-width: 28px;">
                                    <span style="color: #ccc; font-size: 8px;">0%</span>
                                </td>
                            `;
                        }

                        return `
                        <tr>
                            <td style="border: 0.5px solid #999; padding: 4px; text-align: center; font-size: 10px; width: 5%;">${i + 1}</td>
                            <td style="border: 0.5px solid #999; padding: 4px; font-size: 10px; width: ${esIngles ? '15%' : '20%'};">
                                <div contenteditable="true" style="width: 100%; min-height: 22px; max-height: 45px; overflow-y: auto; font-size: 10px; padding: 2px; word-wrap: break-word; white-space: normal; line-height: 1.2; border: none; outline: none;" data-placeholder="Ingrese el componente"></div>
                            </td>
                            <td style="border: 0.5px solid #999; padding: 4px; font-size: 10px; width: ${esIngles ? '25%' : '30%'}; max-width: ${esIngles ? '180px' : '220px'};">
                                <div contenteditable="true" style="width: 100%; height: 22px; overflow-y: auto; font-size: 8px; padding: 2px; white-space: normal; word-wrap: break-word; line-height: 1.1; border: none; outline: none;" data-placeholder="Ingrese el indicador"></div>
                            </td>
                            <td style="border: 0.5px solid #999; padding: 4px; text-align: center; font-size: 10px; color: #FF4D4D; width: ${esIngles ? '15%' : '18%'};">
                                <input type="text" style="width: 100%; border: none; font-size: 9px; padding: 0; text-align: center; color: #FF4D4D;" placeholder="ERRASTE x PREGUNTAS">
                            </td>
                            <td style="border: 1px solid #ccc; padding: 3px; text-align: center; font-size: 10px; width: ${esIngles ? '28px' : '35px'}; height: 22px; background-color: #f5f5f5; min-width: ${esIngles ? '28px' : '35px'}; max-width: ${esIngles ? '28px' : '35px'};">
                                <span style="color: #ccc; font-size: 8px;">0%</span>
                            </td>
                            <td style="border: 1px solid #ccc; padding: 3px; text-align: center; font-size: 10px; width: ${esIngles ? '28px' : '35px'}; height: 22px; background-color: #f5f5f5; min-width: ${esIngles ? '28px' : '35px'}; max-width: ${esIngles ? '28px' : '35px'};">
                                <span style="color: #ccc; font-size: 8px;">0%</span>
                            </td>
                            <td style="border: 1px solid #ccc; padding: 3px; text-align: center; font-size: 10px; width: ${esIngles ? '28px' : '35px'}; height: 22px; background-color: #f5f5f5; min-width: ${esIngles ? '28px' : '35px'}; max-width: ${esIngles ? '28px' : '35px'};">
                                <span style="color: #ccc; font-size: 8px;">0%</span>
                            </td>
                            <td style="border: 1px solid #ccc; padding: 3px; text-align: center; font-size: 10px; width: ${esIngles ? '28px' : '35px'}; height: 22px; background-color: #f5f5f5; min-width: ${esIngles ? '28px' : '35px'}; max-width: ${esIngles ? '28px' : '35px'};">
                                <span style="color: #ccc; font-size: 8px;">0%</span>
                            </td>
                            ${columnasAdicionalesVacias}
                        </tr>
                        `;
                    }
                });

                // Crear la fila de resumen REAL con los datos de la materia
                let filaResumenReal = '';
                if (componentesArray.length > 0) {
                    // Calcular porcentaje para el resumen basado en los errores totales de la materia
                    const totalErroresMateria = estadisticas.errores_especificos;
                    const porcentajePrincipalResumen = calcularPorcentajePorErrores(nombreMateria, totalErroresMateria);
                    const porcentajesDistribuidosResumen = generarPorcentajesComplementarios(porcentajePrincipalResumen);

                    // Determinar el porcentaje mÃ¡s alto para el resumen (solo esa celda serÃ¡ verde)
                    const porcentajesResumen = [porcentajesDistribuidosResumen.A, porcentajesDistribuidosResumen.B, porcentajesDistribuidosResumen.C, porcentajesDistribuidosResumen.D];
                    const maxPorcentajeResumen = Math.max(...porcentajesResumen);

                    // FunciÃ³n para obtener color del resumen - solo el mÃ¡s alto serÃ¡ verde
                    function obtenerColorResumen(porcentaje) {
                        return porcentaje === maxPorcentajeResumen && porcentaje > 0 ? '#4CAF50' : '#FF4D4D';
                    }

                    // Crear columnas adicionales para el resumen de inglÃ©s
                    let columnasResumenAdicionales = '';
                    if (esIngles) {
                        // Para inglÃ©s, definir porcentajes fijos para las columnas adicionales
                        const porcentajeE = 15;
                        const porcentajeF = 12;
                        const porcentajeG = 8;
                        const porcentajeH = 10;

                        // Incluir todas las columnas de inglÃ©s en la comparaciÃ³n
                        const porcentajesInglesResumen = [porcentajesDistribuidosResumen.A, porcentajesDistribuidosResumen.B, porcentajesDistribuidosResumen.C, porcentajesDistribuidosResumen.D, porcentajeE, porcentajeF, porcentajeG, porcentajeH];
                        const maxPorcentajeInglesResumen = Math.max(...porcentajesInglesResumen);

                        function obtenerColorResumenIngles(porcentaje) {
                            return porcentaje === maxPorcentajeInglesResumen && porcentaje > 0 ? '#4CAF50' : '#FF4D4D';
                        }

                        columnasResumenAdicionales = `
                            <td style="border: 2px solid ${obtenerColorResumenIngles(porcentajeE)}; padding: 4px; text-align: center; font-size: 11px; width: 28px; height: 28px; background-color: white; min-width: 28px; max-width: 28px;">
                                <strong style="font-size: 9px; color: ${obtenerColorResumenIngles(porcentajeE)};">E: ${porcentajeE}%</strong>
                            </td>
                            <td style="border: 2px solid ${obtenerColorResumenIngles(porcentajeF)}; padding: 4px; text-align: center; font-size: 11px; width: 28px; height: 28px; background-color: white; min-width: 28px; max-width: 28px;">
                                <strong style="font-size: 9px; color: ${obtenerColorResumenIngles(porcentajeF)};">F: ${porcentajeF}%</strong>
                            </td>
                            <td style="border: 2px solid ${obtenerColorResumenIngles(porcentajeG)}; padding: 4px; text-align: center; font-size: 11px; width: 28px; height: 28px; background-color: white; min-width: 28px; max-width: 28px;">
                                <strong style="font-size: 9px; color: ${obtenerColorResumenIngles(porcentajeG)};">G: ${porcentajeG}%</strong>
                            </td>
                            <td style="border: 2px solid ${obtenerColorResumenIngles(porcentajeH)}; padding: 4px; text-align: center; font-size: 11px; width: 28px; height: 28px; background-color: white; min-width: 28px; max-width: 28px;">
                                <strong style="font-size: 9px; color: ${obtenerColorResumenIngles(porcentajeH)};">H: ${porcentajeH}%</strong>
                            </td>
                        `;

                        // Para inglÃ©s, usar la funciÃ³n especÃ­fica de inglÃ©s
                        filaResumenReal = `
                            <tr style="background-color: #e3f2fd; border-top: 3px solid #1976d2; font-weight: bold;">
                                <td colspan="4" style="border: 1px solid #999; padding: 8px; text-align: center; font-size: 12px; font-weight: bold; color: #1976d2;">
                                    ðŸ“Š RESUMEN ${nombreMateria}: ${estadisticas.errores_especificos} errores de ${estadisticas.total_preguntas} preguntas | ${componentesArray.length} componentes Ãºnicos
                                </td>
                                <td style="border: 2px solid ${obtenerColorResumenIngles(porcentajesDistribuidosResumen.A)}; padding: 4px; text-align: center; font-size: 11px; width: 28px; height: 28px; background-color: white; min-width: 28px; max-width: 28px;">
                                    <strong style="font-size: 9px; color: ${obtenerColorResumenIngles(porcentajesDistribuidosResumen.A)};">A: ${porcentajesDistribuidosResumen.A}%</strong>
                                </td>
                                <td style="border: 2px solid ${obtenerColorResumenIngles(porcentajesDistribuidosResumen.B)}; padding: 4px; text-align: center; font-size: 11px; width: 28px; height: 28px; background-color: white; min-width: 28px; max-width: 28px;">
                                    <strong style="font-size: 9px; color: ${obtenerColorResumenIngles(porcentajesDistribuidosResumen.B)};">B: ${porcentajesDistribuidosResumen.B}%</strong>
                                </td>
                                <td style="border: 2px solid ${obtenerColorResumenIngles(porcentajesDistribuidosResumen.C)}; padding: 4px; text-align: center; font-size: 11px; width: 28px; height: 28px; background-color: white; min-width: 28px; max-width: 28px;">
                                    <strong style="font-size: 9px; color: ${obtenerColorResumenIngles(porcentajesDistribuidosResumen.C)};">C: ${porcentajesDistribuidosResumen.C}%</strong>
                                </td>
                                <td style="border: 2px solid ${obtenerColorResumenIngles(porcentajesDistribuidosResumen.D)}; padding: 4px; text-align: center; font-size: 11px; width: 28px; height: 28px; background-color: white; min-width: 28px; max-width: 28px;">
                                    <strong style="font-size: 9px; color: ${obtenerColorResumenIngles(porcentajesDistribuidosResumen.D)};">D: ${porcentajesDistribuidosResumen.D}%</strong>
                                </td>
                                ${columnasResumenAdicionales}
                            </tr>
                        `;
                    } else {
                        // Para materias que no son inglÃ©s, usar la funciÃ³n normal
                        filaResumenReal = `
                            <tr style="background-color: #e3f2fd; border-top: 3px solid #1976d2; font-weight: bold;">
                                <td colspan="4" style="border: 1px solid #999; padding: 8px; text-align: center; font-size: 12px; font-weight: bold; color: #1976d2;">
                                    ðŸ“Š RESUMEN ${nombreMateria}: ${estadisticas.errores_especificos} errores de ${estadisticas.total_preguntas} preguntas | ${componentesArray.length} componentes Ãºnicos
                                </td>
                                <td style="border: 2px solid ${obtenerColorResumen(porcentajesDistribuidosResumen.A)}; padding: 4px; text-align: center; font-size: 11px; width: 35px; height: 28px; background-color: white; min-width: 35px; max-width: 35px;">
                                    <strong style="font-size: 9px; color: ${obtenerColorResumen(porcentajesDistribuidosResumen.A)};">A: ${porcentajesDistribuidosResumen.A}%</strong>
                                </td>
                                <td style="border: 2px solid ${obtenerColorResumen(porcentajesDistribuidosResumen.B)}; padding: 4px; text-align: center; font-size: 11px; width: 35px; height: 28px; background-color: white; min-width: 35px; max-width: 35px;">
                                    <strong style="font-size: 9px; color: ${obtenerColorResumen(porcentajesDistribuidosResumen.B)};">B: ${porcentajesDistribuidosResumen.B}%</strong>
                                </td>
                                <td style="border: 2px solid ${obtenerColorResumen(porcentajesDistribuidosResumen.C)}; padding: 4px; text-align: center; font-size: 11px; width: 35px; height: 28px; background-color: white; min-width: 35px; max-width: 35px;">
                                    <strong style="font-size: 9px; color: ${obtenerColorResumen(porcentajesDistribuidosResumen.C)};">C: ${porcentajesDistribuidosResumen.C}%</strong>
                                </td>
                                <td style="border: 2px solid ${obtenerColorResumen(porcentajesDistribuidosResumen.D)}; padding: 4px; text-align: center; font-size: 11px; width: 35px; height: 28px; background-color: white; min-width: 35px; max-width: 35px;">
                                    <strong style="font-size: 9px; color: ${obtenerColorResumen(porcentajesDistribuidosResumen.D)};">D: ${porcentajesDistribuidosResumen.D}%</strong>
                                </td>
                            </tr>
                        `;
                    }
                }

                // Crear encabezados de tabla dinÃ¡micos segÃºn la materia
                let encabezadosColumnas = `
                    <th style="border: 0.5px solid #999; padding: 4px; text-align: center; font-size: 10px; width: 5%;">P</th>
                    <th style="border: 0.5px solid #999; padding: 4px; text-align: center; font-size: 10px; width: ${esIngles ? '15%' : '20%'};">COMPONENTE</th>
                    <th style="border: 0.5px solid #999; padding: 4px; text-align: center; font-size: 10px; width: ${esIngles ? '25%' : '30%'};">INDICADOR DE DESEMPEÃ‘O</th>
                    <th style="border: 0.5px solid #999; padding: 4px; text-align: center; font-size: 10px; width: ${esIngles ? '15%' : '18%'};">CANTIDAD DE ERRORES</th>
                    <th style="border: 0.5px solid #999; padding: 4px; text-align: center; font-size: 10px; width: ${esIngles ? '28px' : '35px'};">A</th>
                    <th style="border: 0.5px solid #999; padding: 4px; text-align: center; font-size: 10px; width: ${esIngles ? '28px' : '35px'};">B</th>
                    <th style="border: 0.5px solid #999; padding: 4px; text-align: center; font-size: 10px; width: ${esIngles ? '28px' : '35px'};">C</th>
                    <th style="border: 0.5px solid #999; padding: 4px; text-align: center; font-size: 10px; width: ${esIngles ? '28px' : '35px'};">D</th>
                `;

                if (esIngles) {
                    encabezadosColumnas += `
                        <th style="border: 0.5px solid #999; padding: 4px; text-align: center; font-size: 10px; width: 28px;">E</th>
                        <th style="border: 0.5px solid #999; padding: 4px; text-align: center; font-size: 10px; width: 28px;">F</th>
                        <th style="border: 0.5px solid #999; padding: 4px; text-align: center; font-size: 10px; width: 28px;">G</th>
                        <th style="border: 0.5px solid #999; padding: 4px; text-align: center; font-size: 10px; width: 28px;">H</th>
                    `;
                }

                tablaComponentes.innerHTML = `
                    <table class="tabla-analisis">
                        <thead>
                            <tr>
                                <th>P</th>
                                <th>COMPONENTE</th>
                                <th>INDICADOR DE DESEMPEÃ‘O</th>
                                <th>CANTIDAD DE ERRORES</th>
                                <th>A</th>
                                <th>B</th>
                                <th>C</th>
                                <th>D</th>
                                ${esIngles ? '<th>E</th><th>F</th><th>G</th><th>H</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
                            ${filasTabla.join('')}
                            ${filaResumenReal}
                        </tbody>
                    </table>
                `;
                contenedor.appendChild(tablaComponentes);

                // Generar recomendaciones personalizadas basadas en el desempeÃ±o
                const recomendaciones = generarRecomendaciones(nombreMateria, componentesArray, estadisticas);
                const seccionRecomendaciones = document.createElement('div');
                seccionRecomendaciones.style.cssText = 'margin-top: 25px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; padding: 20px; border-left: 5px solid #007bff; width: 100%; box-sizing: border-box; overflow: visible; word-wrap: break-word;';
                seccionRecomendaciones.innerHTML = recomendaciones;
                contenedor.appendChild(seccionRecomendaciones);

                nuevaHoja.appendChild(contenedor);

                // AÃ±adir botÃ³n para eliminar esta hoja
                const botonEliminar = document.createElement('button');
                botonEliminar.className = 'boton-eliminar-hoja';
                botonEliminar.innerHTML = '<i class="fas fa-trash"></i>';
                botonEliminar.title = 'Eliminar esta hoja';
                botonEliminar.onclick = function () {
                    eliminarHoja(nuevaHoja.id);
                };
                nuevaHoja.appendChild(botonEliminar);

                // AÃ±adir la nueva hoja al contenedor principal
                document.querySelector('.contenedor-principal').appendChild(nuevaHoja);

                // Animar la apariciÃ³n de la nueva hoja
                setTimeout(() => {
                    nuevaHoja.style.opacity = '1';
                }, 10);
            }

            // Generar Plan de Estudio
            document.getElementById('generarPlan').addEventListener('click', async function () {
                // Eliminar solo las hojas de grÃ¡ficas y plan de estudio anteriores, preservando las de anÃ¡lisis
                document.querySelectorAll('.hoja-adicional').forEach(hoja => {
                    if (hoja.id === 'documento_graficas' ||
                        hoja.id === 'documento_analisis' ||
                        hoja.id === 'documento_plan_estudio_1' ||
                        hoja.id === 'documento_plan_estudio_2') {
                        hoja.remove();
                    }
                });

                // Crear la hoja de grÃ¡ficas
                const hojaGraficas = document.createElement('div');
                hojaGraficas.className = 'hoja-adicional';
                hojaGraficas.id = 'documento_graficas';

                // AÃ±adir la marca de agua
                const marcaAguaGraficas = document.createElement('div');
                marcaAguaGraficas.className = 'marca-agua-container';
                const imgMarcaGraficas = document.createElement('img');
                imgMarcaGraficas.src = "/assets/watermarks/marca_de_agua.svg";
                imgMarcaGraficas.alt = "Marca de agua";
                imgMarcaGraficas.className = "marca-agua-imagen";
                marcaAguaGraficas.appendChild(imgMarcaGraficas);
                hojaGraficas.appendChild(marcaAguaGraficas);

                // Crear pÃ¡gina Ã­ndice de grÃ¡ficas
                const contenidoIndice = document.createElement('div');
                contenidoIndice.className = 'contenido-adicional';
                contenidoIndice.innerHTML = `
                    <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50; font-size: 2.2em;">Ãndice de AnÃ¡lisis Detallado</h2>
                    <div class="indice-graficas">
                        <div class="indice-item">
                            <div class="indice-numero">1</div>
                            <div class="indice-contenido">
                                <h3>Lectura CrÃ­tica</h3>
                                <p>AnÃ¡lisis de comprensiÃ³n lectora, interpretaciÃ³n textual y pensamiento crÃ­tico</p>
                            </div>
                        </div>
                        <div class="indice-item">
                            <div class="indice-numero">2</div>
                            <div class="indice-contenido">
                                <h3>MatemÃ¡ticas</h3>
                                <p>EvaluaciÃ³n de competencias en Ã¡lgebra, geometrÃ­a y estadÃ­stica</p>
                            </div>
                        </div>
                        <div class="indice-item">
                            <div class="indice-numero">3</div>
                            <div class="indice-contenido">
                                <h3>Ciencias Sociales</h3>
                                <p>AnÃ¡lisis de pensamiento histÃ³rico, geogrÃ¡fico y competencias ciudadanas</p>
                            </div>
                        </div>
                        <div class="indice-item">
                            <div class="indice-numero">4</div>
                            <div class="indice-contenido">
                                <h3>Ciencias Naturales</h3>
                                <p>Competencias cientÃ­ficas en biologÃ­a, fÃ­sica y quÃ­mica</p>
                            </div>
                        </div>
                        <div class="indice-item">
                            <div class="indice-numero">5</div>
                            <div class="indice-contenido">
                                <h3>InglÃ©s</h3>
                                <p>EvaluaciÃ³n de habilidades comunicativas en lengua extranjera</p>
                            </div>
                        </div>
                    </div>
                    <div class="nota-explicativa">
                        <h4>ðŸ“Š InterpretaciÃ³n de GrÃ¡ficas</h4>
                        <p>Cada materia presenta una visualizaciÃ³n especÃ­fica que facilita la comprensiÃ³n de los resultados:</p>
                        <ul>
                            <li><strong>GrÃ¡ficas de Barras:</strong> Muestran comparaciones directas entre componentes</li>
                            <li><strong>GrÃ¡ficas Radar:</strong> Revelan fortalezas y debilidades en mÃºltiples dimensiones</li>
                            <li><strong>GrÃ¡ficas de LÃ­neas:</strong> Indican tendencias y progresiÃ³n en competencias</li>
                            <li><strong>GrÃ¡ficas de Dona:</strong> Presentan la distribuciÃ³n proporcional de habilidades</li>
                        </ul>
                    </div>
                `;
                hojaGraficas.appendChild(contenidoIndice);

                // Crear hojas individuales para cada grÃ¡fica

                // Hoja 1: Lectura CrÃ­tica
                const hojaLecturaCritica = document.createElement('div');
                hojaLecturaCritica.className = 'hoja-adicional';
                hojaLecturaCritica.id = 'hoja_lectura_critica';

                const marcaAguaLC = document.createElement('div');
                marcaAguaLC.className = 'marca-agua-container';
                const imgMarcaLC = document.createElement('img');
                imgMarcaLC.src = "/assets/watermarks/marca_de_agua.svg";
                imgMarcaLC.alt = "Marca de agua";
                imgMarcaLC.className = "marca-agua-imagen";
                marcaAguaLC.appendChild(imgMarcaLC);
                hojaLecturaCritica.appendChild(marcaAguaLC);

                const contenidoLC = document.createElement('div');
                contenidoLC.className = 'contenido-adicional';
                contenidoLC.innerHTML = `
                    <div class="hoja-grafica-individual">
                        <div class="encabezado-materia lectura-critica">
                            <h2>ðŸ“š LECTURA CRÃTICA</h2>
                            <p class="subtitulo">AnÃ¡lisis de ComprensiÃ³n Lectora y Pensamiento CrÃ­tico</p>
                        </div>
                        
                        <div class="contenido-grafica-individual">
                            <div class="grafica-principal">
                                <div class="grafica-canvas-container-individual">
                                    <canvas id="graficoLecturaCritica"></canvas>
                                </div>
                            </div>
                            
                            <div class="panel-explicacion">
                                <div class="estadisticas-detalladas">
                                    <h3>ðŸ“Š EstadÃ­sticas de Rendimiento</h3>
                                    <div class="stats-grid">
                                        <div class="stat-card promedio">
                                            <div class="stat-value" id="promedioLC">-</div>
                                            <div class="stat-label">Promedio</div>
                                        </div>
                                        <div class="stat-card percentil">
                                            <div class="stat-value" id="percentilLC">-</div>
                                            <div class="stat-label">Percentil</div>
                                        </div>
                                        <div class="stat-card nivel">
                                            <div class="stat-value" id="nivelLC">-</div>
                                            <div class="stat-label">Nivel</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="interpretacion-resultado">
                                    <h3>ðŸ” InterpretaciÃ³n de Resultados</h3>
                                    <div class="interpretacion-content" id="interpretacionLC">
                                        <p>Los resultados de Lectura CrÃ­tica se analizarÃ¡n segÃºn tu desempeÃ±o especÃ­fico.</p>
                                    </div>
                                </div>
                                
                                <div class="recomendaciones-personalizadas">
                                    <h3>ðŸ’¡ RecomendaciÃ³n Personal</h3>
                                    <div class="recomendacion-content" id="recomendacionLC">
                                        <p>Las recomendaciones se generarÃ¡n segÃºn tu nivel de desempeÃ±o.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                hojaLecturaCritica.appendChild(contenidoLC);

                // Hoja 2: MatemÃ¡ticas
                const hojaMatematicas = document.createElement('div');
                hojaMatematicas.className = 'hoja-adicional';
                hojaMatematicas.id = 'hoja_matematicas';

                const marcaAguaMT = document.createElement('div');
                marcaAguaMT.className = 'marca-agua-container';
                const imgMarcaMT = document.createElement('img');
                imgMarcaMT.src = "/assets/watermarks/marca_de_agua.svg";
                imgMarcaMT.alt = "Marca de agua";
                imgMarcaMT.className = "marca-agua-imagen";
                marcaAguaMT.appendChild(imgMarcaMT);
                hojaMatematicas.appendChild(marcaAguaMT);

                const contenidoMT = document.createElement('div');
                contenidoMT.className = 'contenido-adicional';
                contenidoMT.innerHTML = `
                    <div class="hoja-grafica-individual">
                        <div class="encabezado-materia matematicas">
                            <h2>ðŸ”¢ MATEMÃTICAS</h2>
                            <p class="subtitulo">Razonamiento Cuantitativo y Competencias MatemÃ¡ticas</p>
                        </div>
                        
                        <div class="contenido-grafica-individual">
                            <div class="grafica-principal">
                                <div class="grafica-canvas-container-individual">
                                    <canvas id="graficoMatematicas"></canvas>
                                </div>
                            </div>
                            
                            <div class="panel-explicacion">
                                <div class="estadisticas-detalladas">
                                    <h3>ðŸ“Š EstadÃ­sticas de Rendimiento</h3>
                                    <div class="stats-grid">
                                        <div class="stat-card promedio">
                                            <div class="stat-value" id="promedioMT">-</div>
                                            <div class="stat-label">Promedio</div>
                                        </div>
                                        <div class="stat-card percentil">
                                            <div class="stat-value" id="percentilMT">-</div>
                                            <div class="stat-label">Percentil</div>
                                        </div>
                                        <div class="stat-card nivel">
                                            <div class="stat-value" id="nivelMT">-</div>
                                            <div class="stat-label">Nivel</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="interpretacion-resultado">
                                    <h3>ðŸ” InterpretaciÃ³n de Resultados</h3>
                                    <div class="interpretacion-content" id="interpretacionMT">
                                        <p>Los resultados de MatemÃ¡ticas se analizarÃ¡n segÃºn tu desempeÃ±o especÃ­fico.</p>
                                    </div>
                                </div>
                                
                                <div class="recomendaciones-personalizadas">
                                    <h3>ðŸ’¡ RecomendaciÃ³n Personal</h3>
                                    <div class="recomendacion-content" id="recomendacionMT">
                                        <p>Las recomendaciones se generarÃ¡n segÃºn tu nivel de desempeÃ±o.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                hojaMatematicas.appendChild(contenidoMT);

                // Hoja 3: Ciencias Sociales
                const hojaSociales = document.createElement('div');
                hojaSociales.className = 'hoja-adicional';
                hojaSociales.id = 'hoja_sociales';

                const marcaAguaSC = document.createElement('div');
                marcaAguaSC.className = 'marca-agua-container';
                const imgMarcaSC = document.createElement('img');
                imgMarcaSC.src = "/assets/watermarks/marca_de_agua.svg";
                imgMarcaSC.alt = "Marca de agua";
                imgMarcaSC.className = "marca-agua-imagen";
                marcaAguaSC.appendChild(imgMarcaSC);
                hojaSociales.appendChild(marcaAguaSC);

                const contenidoSC = document.createElement('div');
                contenidoSC.className = 'contenido-adicional';
                contenidoSC.innerHTML = `
                    <div class="hoja-grafica-individual">
                        <div class="encabezado-materia sociales">
                            <h2>ðŸŒ CIENCIAS SOCIALES Y CIUDADANAS</h2>
                            <p class="subtitulo">Pensamiento Social y Competencias Ciudadanas</p>
                        </div>
                        
                        <div class="contenido-grafica-individual">
                            <div class="grafica-principal">
                                <div class="grafica-canvas-container-individual">
                                    <canvas id="graficoSociales"></canvas>
                                </div>
                            </div>
                            
                            <div class="panel-explicacion">
                                <div class="estadisticas-detalladas">
                                    <h3>ðŸ“Š EstadÃ­sticas de Rendimiento</h3>
                                    <div class="stats-grid">
                                        <div class="stat-card promedio">
                                            <div class="stat-value" id="promedioSC">-</div>
                                            <div class="stat-label">Promedio</div>
                                        </div>
                                        <div class="stat-card percentil">
                                            <div class="stat-value" id="percentilSC">-</div>
                                            <div class="stat-label">Percentil</div>
                                        </div>
                                        <div class="stat-card nivel">
                                            <div class="stat-value" id="nivelSC">-</div>
                                            <div class="stat-label">Nivel</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="interpretacion-resultado">
                                    <h3>ðŸ” InterpretaciÃ³n de Resultados</h3>
                                    <div class="interpretacion-content" id="interpretacionSC">
                                        <p>Los resultados de Ciencias Sociales se analizarÃ¡n segÃºn tu desempeÃ±o especÃ­fico.</p>
                                    </div>
                                </div>
                                
                                <div class="recomendaciones-personalizadas">
                                    <h3>ðŸ’¡ RecomendaciÃ³n Personal</h3>
                                    <div class="recomendacion-content" id="recomendacionSC">
                                        <p>Las recomendaciones se generarÃ¡n segÃºn tu nivel de desempeÃ±o.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                hojaSociales.appendChild(contenidoSC);

                // Hoja 4: Ciencias Naturales
                const hojaNaturales = document.createElement('div');
                hojaNaturales.className = 'hoja-adicional';
                hojaNaturales.id = 'hoja_naturales';

                const marcaAguaCN = document.createElement('div');
                marcaAguaCN.className = 'marca-agua-container';
                const imgMarcaCN = document.createElement('img');
                imgMarcaCN.src = "/assets/watermarks/marca_de_agua.svg";
                imgMarcaCN.alt = "Marca de agua";
                imgMarcaCN.className = "marca-agua-imagen";
                marcaAguaCN.appendChild(imgMarcaCN);
                hojaNaturales.appendChild(marcaAguaCN);

                const contenidoCN = document.createElement('div');
                contenidoCN.className = 'contenido-adicional';
                contenidoCN.innerHTML = `
                    <div class="hoja-grafica-individual">
                        <div class="encabezado-materia naturales">
                            <h2>ðŸ”¬ CIENCIAS NATURALES</h2>
                            <p class="subtitulo">Competencias CientÃ­ficas e InvestigaciÃ³n</p>
                        </div>
                        
                        <div class="contenido-grafica-individual">
                            <div class="grafica-principal">
                                <div class="grafica-canvas-container-individual">
                                    <canvas id="graficoNaturales"></canvas>
                                </div>
                            </div>
                            
                            <div class="panel-explicacion">
                                <div class="estadisticas-detalladas">
                                    <h3>ðŸ“Š EstadÃ­sticas de Rendimiento</h3>
                                    <div class="stats-grid">
                                        <div class="stat-card promedio">
                                            <div class="stat-value" id="promedioCN">-</div>
                                            <div class="stat-label">Promedio</div>
                                        </div>
                                        <div class="stat-card percentil">
                                            <div class="stat-value" id="percentilCN">-</div>
                                            <div class="stat-label">Percentil</div>
                                        </div>
                                        <div class="stat-card nivel">
                                            <div class="stat-value" id="nivelCN">-</div>
                                            <div class="stat-label">Nivel</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="interpretacion-resultado">
                                    <h3>ðŸ” InterpretaciÃ³n de Resultados</h3>
                                    <div class="interpretacion-content" id="interpretacionCN">
                                        <p>Los resultados de Ciencias Naturales se analizarÃ¡n segÃºn tu desempeÃ±o especÃ­fico.</p>
                                    </div>
                                </div>
                                
                                <div class="recomendaciones-personalizadas">
                                    <h3>ðŸ’¡ RecomendaciÃ³n Personal</h3>
                                    <div class="recomendacion-content" id="recomendacionCN">
                                        <p>Las recomendaciones se generarÃ¡n segÃºn tu nivel de desempeÃ±o.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                hojaNaturales.appendChild(contenidoCN);

                // Hoja 5: InglÃ©s
                const hojaIngles = document.createElement('div');
                hojaIngles.className = 'hoja-adicional';
                hojaIngles.id = 'hoja_ingles';

                const marcaAguaIN = document.createElement('div');
                marcaAguaIN.className = 'marca-agua-container';
                const imgMarcaIN = document.createElement('img');
                imgMarcaIN.src = "/assets/watermarks/marca_de_agua.svg";
                imgMarcaIN.alt = "Marca de agua";
                imgMarcaIN.className = "marca-agua-imagen";
                marcaAguaIN.appendChild(imgMarcaIN);
                hojaIngles.appendChild(marcaAguaIN);

                const contenidoIN = document.createElement('div');
                contenidoIN.className = 'contenido-adicional';
                contenidoIN.innerHTML = `
                    <div class="hoja-grafica-individual">
                        <div class="encabezado-materia ingles">
                            <h2>ðŸ—£ï¸ INGLÃ‰S</h2>
                            <p class="subtitulo">Competencias Comunicativas en Lengua Extranjera</p>
                        </div>
                        
                        <div class="contenido-grafica-individual">
                            <div class="grafica-principal">
                                <div class="grafica-canvas-container-individual">
                                    <canvas id="graficoIngles"></canvas>
                                </div>
                            </div>
                            
                            <div class="panel-explicacion">
                                <div class="estadisticas-detalladas">
                                    <h3>ðŸ“Š EstadÃ­sticas de Rendimiento</h3>
                                    <div class="stats-grid">
                                        <div class="stat-card promedio">
                                            <div class="stat-value" id="promedioIN">-</div>
                                            <div class="stat-label">Promedio</div>
                                        </div>
                                        <div class="stat-card percentil">
                                            <div class="stat-value" id="percentilIN">-</div>
                                            <div class="stat-label">Percentil</div>
                                        </div>
                                        <div class="stat-card nivel">
                                            <div class="stat-value" id="nivelIN">-</div>
                                            <div class="stat-label">Nivel</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="interpretacion-resultado">
                                    <h3>ðŸ” InterpretaciÃ³n de Resultados</h3>
                                    <div class="interpretacion-content" id="interpretacionIN">
                                        <p>Los resultados de InglÃ©s se analizarÃ¡n segÃºn tu desempeÃ±o especÃ­fico.</p>
                                    </div>
                                </div>
                                
                                <div class="recomendaciones-personalizadas">
                                    <h3>ðŸ’¡ RecomendaciÃ³n Personal</h3>
                                    <div class="recomendacion-content" id="recomendacionIN">
                                        <p>Las recomendaciones se generarÃ¡n segÃºn tu nivel de desempeÃ±o.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                hojaIngles.appendChild(contenidoIN);

                // Crear la hoja de anÃ¡lisis
                const hojaAnalisis = document.createElement('div');
                hojaAnalisis.className = 'hoja-adicional';
                hojaAnalisis.id = 'documento_analisis';

                // AÃ±adir la marca de agua para anÃ¡lisis
                const marcaAguaAnalisis = document.createElement('div');
                marcaAguaAnalisis.className = 'marca-agua-container';
                const imgMarcaAnalisis = document.createElement('img');
                imgMarcaAnalisis.src = "/assets/watermarks/marca_de_agua.svg";
                imgMarcaAnalisis.alt = "Marca de agua";
                imgMarcaAnalisis.className = "marca-agua-imagen";
                marcaAguaAnalisis.appendChild(imgMarcaAnalisis);
                hojaAnalisis.appendChild(marcaAguaAnalisis);

                // Crear y aÃ±adir el contenido de anÃ¡lisis
                const contenidoAnalisis = document.createElement('div');
                contenidoAnalisis.className = 'contenido-adicional';
                contenidoAnalisis.innerHTML = `
                    <h2 style="text-align: center; margin-bottom: 20px;">Plan de Estudio Personalizado</h2>
                    <!-- El contenido del plan de estudio se generarÃ¡ dinÃ¡micamente -->
                `;
                hojaAnalisis.appendChild(contenidoAnalisis);

                // Crear la primera hoja de plan de estudio
                const hojaPlanEstudio1 = document.createElement('div');
                hojaPlanEstudio1.className = 'hoja-adicional';
                hojaPlanEstudio1.id = 'documento_plan_estudio_1';

                // AÃ±adir la marca de agua para plan 1
                const marcaAguaPlan1 = document.createElement('div');
                marcaAguaPlan1.className = 'marca-agua-container';
                const imgMarcaPlan1 = document.createElement('img');
                imgMarcaPlan1.src = "/assets/watermarks/marca_de_agua.svg";
                imgMarcaPlan1.alt = "Marca de agua";
                imgMarcaPlan1.className = "marca-agua-imagen";
                marcaAguaPlan1.appendChild(imgMarcaPlan1);
                hojaPlanEstudio1.appendChild(marcaAguaPlan1);

                // Crear y aÃ±adir el contenido del plan 1
                const contenidoPlan1 = document.createElement('div');
                contenidoPlan1.className = 'contenido-adicional';
                contenidoPlan1.innerHTML = `
                    <h2 style="text-align: center; margin-bottom: 20px;">Plan de Estudio - Parte 1</h2>
                    <!-- El contenido del plan de estudio se generarÃ¡ dinÃ¡micamente -->
                `;
                hojaPlanEstudio1.appendChild(contenidoPlan1);

                // Crear la segunda hoja de plan de estudio
                const hojaPlanEstudio2 = document.createElement('div');
                hojaPlanEstudio2.className = 'hoja-adicional';
                hojaPlanEstudio2.id = 'documento_plan_estudio_2';

                // AÃ±adir la marca de agua para plan 2
                const marcaAguaPlan2 = document.createElement('div');
                marcaAguaPlan2.className = 'marca-agua-container';
                const imgMarcaPlan2 = document.createElement('img');
                imgMarcaPlan2.src = "/assets/watermarks/marca_de_agua.svg";
                imgMarcaPlan2.alt = "Marca de agua";
                imgMarcaPlan2.className = "marca-agua-imagen";
                marcaAguaPlan2.appendChild(imgMarcaPlan2);
                hojaPlanEstudio2.appendChild(marcaAguaPlan2);

                // Crear y aÃ±adir el contenido del plan 2
                const contenidoPlan2 = document.createElement('div');
                contenidoPlan2.className = 'contenido-adicional';
                contenidoPlan2.innerHTML = `
                    <h2 style="text-align: center; margin-bottom: 20px;">Plan de Estudio - Parte 2</h2>
                    <!-- El contenido del plan de estudio se generarÃ¡ dinÃ¡micamente -->
                `;
                hojaPlanEstudio2.appendChild(contenidoPlan2);

                // Agregar botones de eliminar a cada hoja de plan
                const botonEliminar1 = document.createElement('button');
                botonEliminar1.className = 'boton-eliminar-hoja';
                botonEliminar1.innerHTML = '<i class="fas fa-trash"></i>';
                botonEliminar1.onclick = () => eliminarHoja('documento_plan_estudio_1');
                hojaPlanEstudio1.appendChild(botonEliminar1);

                const botonEliminar2 = document.createElement('button');
                botonEliminar2.className = 'boton-eliminar-hoja';
                botonEliminar2.innerHTML = '<i class="fas fa-trash"></i>';
                botonEliminar2.onclick = () => eliminarHoja('documento_plan_estudio_2');
                hojaPlanEstudio2.appendChild(botonEliminar2);

                // Agregar todas las hojas al contenedor principal
                const contenedorPrincipal = document.querySelector('.contenedor-principal');
                contenedorPrincipal.appendChild(hojaGraficas);
                contenedorPrincipal.appendChild(hojaLecturaCritica);
                contenedorPrincipal.appendChild(hojaMatematicas);
                contenedorPrincipal.appendChild(hojaSociales);
                contenedorPrincipal.appendChild(hojaNaturales);
                contenedorPrincipal.appendChild(hojaIngles);
                contenedorPrincipal.appendChild(hojaAnalisis);
                contenedorPrincipal.appendChild(hojaPlanEstudio1);
                contenedorPrincipal.appendChild(hojaPlanEstudio2);

                // Hacer visibles todas las hojas
                setTimeout(() => {
                    hojaGraficas.style.opacity = '1';
                    hojaLecturaCritica.style.opacity = '1';
                    hojaMatematicas.style.opacity = '1';
                    hojaSociales.style.opacity = '1';
                    hojaNaturales.style.opacity = '1';
                    hojaIngles.style.opacity = '1';
                    hojaAnalisis.style.opacity = '1';
                    hojaPlanEstudio1.style.opacity = '1';
                    hojaPlanEstudio2.style.opacity = '1';

                    // Obtener los datos del estudiante actual
                    const estudianteSeleccionado = document.getElementById('selectorEstudiante').value;
                    if (estudianteSeleccionado !== '') {
                        const estudiante = datosEstudiantes[estudianteSeleccionado];
                        if (estudiante) {
                            // Preparar los datos para las grÃ¡ficas usando puntajes reajustados
                            const datos = {
                                LC: {
                                    ...estudiante.puntajes['lectura crÃ­tica'],
                                    puntaje: reajustarPuntaje(estudiante.puntajes['lectura crÃ­tica'].puntaje)
                                },
                                MT: {
                                    ...estudiante.puntajes['matemÃ¡ticas'],
                                    puntaje: reajustarPuntaje(estudiante.puntajes['matemÃ¡ticas'].puntaje)
                                },
                                SC: {
                                    ...estudiante.puntajes['sociales y ciudadanas'],
                                    puntaje: reajustarPuntaje(estudiante.puntajes['sociales y ciudadanas'].puntaje)
                                },
                                CN: {
                                    ...estudiante.puntajes['ciencias naturales'],
                                    puntaje: reajustarPuntaje(estudiante.puntajes['ciencias naturales'].puntaje)
                                },
                                IN: {
                                    ...estudiante.puntajes['inglÃ©s'],
                                    puntaje: reajustarPuntaje(estudiante.puntajes['inglÃ©s'].puntaje)
                                }
                            };

                            // Actualizar las grÃ¡ficas con los datos reajustados
                            actualizarGraficas(datos);
                        }
                    }

                    // Mostrar ventana emergente de Ã©xito
                    mostrarAlerta(
                        'Plan de Estudio Generado',
                        'El plan de estudio personalizado se ha generado exitosamente',
                        'success'
                    );
                }, 100);
            });
        });

        // FunciÃ³n para generar hojas de estadÃ­sticas automÃ¡ticamente
        async function generarHojasEstadisticas() {
            try {
                console.log('Iniciando generaciÃ³n de hojas estadÃ­sticas...');

                const response = await fetch('/api/estadisticas-grupo');
                const data = await response.json();

                if (data.error) {
                    console.error('Error cargando estadÃ­sticas:', data.error);
                    return;
                }

                console.log('EstadÃ­sticas cargadas:', data);

                const contenedorPrincipal = document.querySelector('.contenedor-principal');
                if (!contenedorPrincipal) {
                    console.error('No se encontrÃ³ contenedor principal');
                    return;
                }

                console.log('Contenedor principal encontrado');
                console.log('data completo:', JSON.stringify(data, null, 2).substring(0, 500));
                console.log('data.materias:', data.materias);
                console.log('Tipo de data.materias:', typeof data.materias);
                console.log('Materias a procesar:', Object.keys(data.materias || {}));

                // Crear una hoja por cada materia
                let hojasCreadas = 0;
                for (const [nombreMateria, datosMateria] of Object.entries(data.materias)) {
                    console.log(`Creando hoja para: ${nombreMateria}`);
                    const hojaEstadistica = crearHojaEstadistica(nombreMateria, datosMateria, data.metadata);
                    contenedorPrincipal.appendChild(hojaEstadistica);
                    hojasCreadas++;
                }

                console.log(`${hojasCreadas} hojas de estadÃ­sticas generadas exitosamente`);

            } catch (error) {
                console.error('Error generando hojas estadÃ­sticas:', error);
            }
        }

        function crearHojaEstadistica(nombreMateria, datosMateria, metadata) {
            const hoja = document.createElement('div');
            hoja.className = 'hoja-adicional';
            hoja.id = `estadistica_${nombreMateria.replace(/\s+/g, '_')}`;
            hoja.style.opacity = '0';
            hoja.style.transition = 'opacity 0.3s ease-in';

            const marcaAgua = document.createElement('div');
            marcaAgua.className = 'marca-agua-container';
            const imgMarca = document.createElement('img');
            imgMarca.src = '/assets/watermarks/marca_de_agua.svg';
            imgMarca.alt = 'Marca de agua';
            imgMarca.className = 'marca-agua-imagen';
            marcaAgua.appendChild(imgMarca);
            hoja.appendChild(marcaAgua);

            const contenido = document.createElement('div');
            contenido.className = 'contenido-adicional';
            contenido.innerHTML = generarHTMLTablaEstadistica(nombreMateria, datosMateria, metadata);
            hoja.appendChild(contenido);

            setTimeout(() => {
                hoja.style.opacity = '1';
            }, 100);

            return hoja;
        }

        function generarHTMLTablaEstadistica(nombreMateria, datosMateria, metadata) {
            const numOpciones = nombreMateria === 'inglÃ©s' ? 8 : 4;
            const opciones = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'].slice(0, numOpciones);

            // ConfiguraciÃ³n de colores e iconos por materia
            const configMateria = {
                'lectura crÃ­tica': {
                    icono: 'ðŸ“š',
                    nombre: 'LECTURA CRÃTICA',
                    gradiente: 'linear-gradient(135deg, #FF4D4D 0%, #FF6B6B 50%, #FF8E8E 100%)',
                    colorPrimario: '#FF4D4D',
                    colorSecundario: '#FF6B6B'
                },
                'matemÃ¡ticas': {
                    icono: 'ðŸ”¢',
                    nombre: 'MATEMÃTICAS',
                    gradiente: 'linear-gradient(135deg, #0066CC 0%, #3399FF 50%, #66B2FF 100%)',
                    colorPrimario: '#0066CC',
                    colorSecundario: '#3399FF'
                },
                'sociales y ciudadanas': {
                    icono: 'ðŸŒ',
                    nombre: 'CIENCIAS SOCIALES',
                    gradiente: 'linear-gradient(135deg, #FF8C00 0%, #FFA500 50%, #FFB84D 100%)',
                    colorPrimario: '#FF8C00',
                    colorSecundario: '#FFA500'
                },
                'ciencias naturales': {
                    icono: 'ðŸ”¬',
                    nombre: 'CIENCIAS NATURALES',
                    gradiente: 'linear-gradient(135deg, #10B981 0%, #34D399 50%, #6EE7B7 100%)',
                    colorPrimario: '#10B981',
                    colorSecundario: '#34D399'
                },
                'inglÃ©s': {
                    icono: 'ðŸ—£ï¸',
                    nombre: 'INGLÃ‰S',
                    gradiente: 'linear-gradient(135deg, #8B5CF6 0%, #A78BFA 50%, #C4B5FD 100%)',
                    colorPrimario: '#8B5CF6',
                    colorSecundario: '#A78BFA'
                }
            };

            // Obtener configuraciÃ³n de la materia actual (con fallback)
            const config = configMateria[nombreMateria.toLowerCase()] || {
                icono: 'ðŸ“Š',
                nombre: nombreMateria.toUpperCase(),
                gradiente: 'linear-gradient(135deg, #6B7280 0%, #9CA3AF 100%)',
                colorPrimario: '#6B7280',
                colorSecundario: '#9CA3AF'
            };

            // Calcular estadÃ­sticas de resumen
            const preguntas = Object.values(datosMateria).sort((a, b) => a.numero - b.numero);
            const totalPreguntas = preguntas.length;
            const preguntasAlto = preguntas.filter(p => p.porcentaje_acierto >= 70).length;
            const preguntasMedio = preguntas.filter(p => p.porcentaje_acierto >= 40 && p.porcentaje_acierto < 70).length;
            const preguntasBajo = preguntas.filter(p => p.porcentaje_acierto < 40).length;
            const promedioGeneral = preguntas.reduce((sum, p) => sum + p.porcentaje_acierto, 0) / totalPreguntas;

            let html = `
                <div class="tabla-estadistica-container">
                    <!-- Header Premium con Gradiente por Materia -->
                    <div class="estadistica-header-premium" style="
                        background: ${config.gradiente};
                        padding: 15px 20px;
                        border-radius: 10px 10px 0 0;
                        margin-bottom: 0;
                        page-break-after: avoid;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                    ">
                        <h2 style="
                            text-align: center;
                            margin: 0 0 8px 0;
                            color: white;
                            font-size: 1.3em;
                            font-weight: 700;
                            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
                            letter-spacing: 0.5px;
                        ">
                            ${config.icono} ANÃLISIS ESTADÃSTICO
                        </h2>
                        <p style="
                            text-align: center;
                            margin: 0;
                            color: rgba(255,255,255,0.95);
                            font-size: 1.1em;
                            font-weight: 600;
                            letter-spacing: 1px;
                        ">
                            ${config.nombre}
                        </p>
                    </div>
                    
                    <!-- Barra de Metadatos -->
                    <div class="estadistica-metadata" style="
                        margin: 0;
                        padding: 10px 15px;
                        font-size: 10px;
                        color: #555;
                        display: flex;
                        flex-wrap: wrap;
                        justify-content: space-between;
                        gap: 10px;
                        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                        border-left: 4px solid ${config.colorPrimario};
                        page-break-after: avoid;
                    ">
                        <span style="display: flex; align-items: center; gap: 4px;">
                            <strong style="color: ${config.colorPrimario};">ðŸ“‹ ÃREA:</strong> ${config.nombre}
                        </span>
                        <span style="display: flex; align-items: center; gap: 4px;">
                            <strong style="color: ${config.colorPrimario};">ðŸ‘¥ Evaluados:</strong> ${metadata.total_evaluados}
                        </span>
                        <span style="display: flex; align-items: center; gap: 4px;">
                            <strong style="color: ${config.colorPrimario};">ðŸ“… Fecha:</strong> ${metadata.fecha_generacion}
                        </span>
                        <span style="display: flex; align-items: center; gap: 4px;">
                            <strong style="color: ${config.colorPrimario};">ðŸ“ˆ Promedio:</strong> 
                            <span style="
                                background: ${promedioGeneral >= 70 ? '#28a745' : promedioGeneral >= 40 ? '#fd7e14' : '#dc3545'};
                                color: white;
                                padding: 2px 8px;
                                border-radius: 10px;
                                font-weight: bold;
                            ">${promedioGeneral.toFixed(1)}%</span>
                        </span>
                    </div>
                    
                    <table class="tabla-estadistica" style="width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 0;">
                        <thead style="display: table-header-group;">
                            <tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                                <th style="border: 1px solid #dee2e6; padding: 8px 4px; font-weight: 600; width: 8%;">#</th>
                                ${opciones.map(op => `<th style="border: 1px solid #dee2e6; padding: 8px 4px; font-weight: 600; width: ${numOpciones === 8 ? '9%' : '12%'};">${op}</th>`).join('')}
                                <th style="border: 1px solid #dee2e6; padding: 8px 4px; font-weight: 600; width: 8%;">NR</th>
                                <th style="border: 1px solid #dee2e6; padding: 8px 4px; font-weight: 600; width: 12%;">%DESEM.</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            preguntas.forEach((pregunta, index) => {
                const correcta = pregunta.respuesta_correcta;

                // Alternar colores de fila para mejor legibilidad
                const fondoFila = index % 2 === 0 ? '#ffffff' : '#f8f9fa';

                html += `<tr style="background-color: ${fondoFila}; page-break-inside: avoid; break-inside: avoid;">`;
                html += `<td style="border: 1px solid #dee2e6; padding: 6px 4px; text-align: center; font-weight: 500;">${pregunta.numero}</td>`;

                opciones.forEach(opcion => {
                    const porcentaje = pregunta.distribucion[opcion] || 0;
                    const esCorrecta = opcion === correcta;
                    const esDistractor = !esCorrecta && porcentaje > 30;

                    let estilo = 'border: 1px solid #dee2e6; padding: 6px 4px; text-align: center;';
                    let contenido = porcentaje.toFixed(1);

                    if (esCorrecta) {
                        estilo += ' background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; font-weight: bold; border-radius: 3px;';
                        contenido = `${porcentaje.toFixed(1)}`;
                    } else if (esDistractor) {
                        estilo += ' background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%); color: white; font-weight: bold; border-radius: 3px;';
                        contenido = `${porcentaje.toFixed(1)}`;
                    }

                    html += `<td style="${estilo}">${contenido}</td>`;
                });

                html += `<td style="border: 1px solid #dee2e6; padding: 6px 4px; text-align: center; color: #6c757d;">${(pregunta.distribucion.NR || 0).toFixed(1)}</td>`;

                const desempeno = pregunta.porcentaje_acierto;
                let estiloDesempeno = 'border: 1px solid #dee2e6; padding: 6px 4px; text-align: center; font-weight: bold;';

                if (desempeno >= 70) {
                    estiloDesempeno += ' color: #28a745;';
                } else if (desempeno >= 40) {
                    estiloDesempeno += ' color: #fd7e14;';
                } else {
                    estiloDesempeno += ' color: #dc3545;';
                }

                html += `<td style="${estiloDesempeno}">${desempeno.toFixed(1)}%</td>`;
                html += `</tr>`;
            });

            html += `</tbody></table>`;

            // Agregar resumen estadÃ­stico (no se corta)
            html += `
                <div class="resumen-tabla" style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 8px; page-break-inside: avoid; break-inside: avoid;">
                    <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px; text-align: center;">
                        <div style="min-width: 80px;">
                            <div style="font-size: 1.2em; font-weight: bold; color: #28a745;">âœ… ${preguntasAlto}</div>
                            <div style="font-size: 0.75em; color: #666;">Alto (â‰¥70%)</div>
                        </div>
                        <div style="min-width: 80px;">
                            <div style="font-size: 1.2em; font-weight: bold; color: #fd7e14;">âš¡ ${preguntasMedio}</div>
                            <div style="font-size: 0.75em; color: #666;">Medio (40-69%)</div>
                        </div>
                        <div style="min-width: 80px;">
                            <div style="font-size: 1.2em; font-weight: bold; color: #dc3545;">âš ï¸ ${preguntasBajo}</div>
                            <div style="font-size: 0.75em; color: #666;">Bajo (&lt;40%)</div>
                        </div>
                        <div style="min-width: 80px;">
                            <div style="font-size: 1.2em; font-weight: bold; color: #2c3e50;">ðŸ“Š ${promedioGeneral.toFixed(1)}%</div>
                            <div style="font-size: 0.75em; color: #666;">Promedio</div>
                        </div>
                    </div>
                </div>
            </div>`;

            return html;
        }

        // PÃ¡gina cargada - ya no se generan hojas de estadÃ­sticas grupales
        window.addEventListener('load', async () => {
            console.log('PÃ¡gina cargada completamente');
            // Las hojas de estadÃ­sticas grupales por materia han sido deshabilitadas
            // El enfoque ahora es mostrar estadÃ­sticas individuales por estudiante
        });
    </script>
    <button class="boton-apagar" onclick="apagarServidor()">
        <i class="fas fa-power-off"></i>
        Apagar Servidor
    </button>

</body>

</html>